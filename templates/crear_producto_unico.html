{% extends "base.html" %}

{% block content %}
<form method="POST" class="styled-form" id="formCrearProductoUnico">
    {# Sección de Información General del Producto Interno #}
    <fieldset class="form-section">
        <legend><h4>Información General del Producto Interno</h4></legend>

        <div class="form-group">
            <label for="nombre_producto">Nombre del Producto Interno: <span class="required-indicator">*</span></label>
            <input type="text" name="nombre_producto" id="nombre_producto" value="{{ request_form_data.nombre_producto or '' }}" required>
            <small class="form-text text-muted">Ej: "Gomita Panditas Bolsa 1kg Sabor Limón", "Globo Látex #9 Rojo Paquete 50pz"</small>
        </div>

        {# Selección de Categoría y Subcategoría #}
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="id_categoria_principal_producto">Categoría Principal:</label>
                <select name="id_categoria_principal_producto" id="id_categoria_principal_producto">
                    <option value="">-- Selecciona una categoría principal (opcional si eliges subcategoría) --</option>
                    {% for cat in categorias_para_select %}
                        <option value="{{ cat.id_categoria }}"
                                data-nombre-categoria="{{ cat.nombre_categoria }}"
                                {% if request_form_data.id_categoria_principal_producto == cat.id_categoria|string %}selected{% endif %}>
                            {{ cat.nombre_categoria }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="id_subcategoria_especifica_producto">Subcategoría Específica:</label>
                <select name="id_subcategoria_especifica_producto" id="id_subcategoria_especifica_producto">
                    <option value="">-- Selecciona una subcategoría (opcional / depende de principal) --</option>
                    {% for subcat in subcategorias_para_select %}
                         <option value="{{ subcat.id_subcategoria }}"
                                 data-id-categoria-contenedora="{{ subcat.id_categoria_contenedora or '' }}"
                                 data-id-subcat-padre="{{ subcat.id_subcategoria_padre or '' }}"
                                 {% if request_form_data.id_subcategoria_especifica_producto == subcat.id_subcategoria|string %}selected{% endif %}>
                             {{ subcat.nombre_subcategoria }}
                             {% if subcat.categoria_contenedora %} ({{ subcat.categoria_contenedora.nombre_categoria }})
                             {% elif subcat.subcategoria_padre %} (Sub de: {{ subcat.subcategoria_padre.nombre_subcategoria }})
                             {% endif %}
                         </option>
                    {% endfor %}
                </select>
                 <small class="form-text text-muted">Un producto debe tener al menos una categoría principal o una subcategoría específica.</small>
            </div>
        </div>

        <div class="form-group">
            <label for="descripcion_adicional">Descripción Adicional (Notas Internas):</label>
            <textarea name="descripcion_adicional" id="descripcion_adicional" rows="2">{{ request_form_data.descripcion_adicional or '' }}</textarea>
        </div>
    </fieldset>

    {# Sección de Detalles de Compra e Inventario #}
    <fieldset class="form-section">
        <legend><h4>Detalles de Compra e Inventario Base</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="presentacion_compra">Presentación de Compra:</label>
                <input type="text" name="presentacion_compra" id="presentacion_compra" value="{{ request_form_data.presentacion_compra or '' }}">
                <small>Ej: "Bolsa 1kg", "Caja 24pz", "Rollo 50m"</small>
            </div>
            <div class="form-group">
                <label for="cantidad_en_presentacion_compra">Cantidad en Presentación de Compra:</label>
                <input type="number" step="any" name="cantidad_en_presentacion_compra" id="cantidad_en_presentacion_compra" value="{{ request_form_data.cantidad_en_presentacion_compra or '' }}">
                <small>En términos de Unidad Base. Ej: Si Presentación="Bolsa 1kg" y Unidad Base="g", aquí va 1000.</small>
            </div>
            <div class="form-group">
                <label for="unidad_medida_base">Unidad de Medida Base: <span class="required-indicator">*</span></label>
                <input type="text" name="unidad_medida_base" id="unidad_medida_base" value="{{ request_form_data.unidad_medida_base or '' }}" required>
                <small>Unidad fundamental. Ej: "g", "ml", "cm", "pieza".</small>
            </div>
        </div>
         <div class="form-group">
            <label for="dias_anticipacion_compra_proveedor">Días Anticipación Compra a Proveedor:</label>
            <input type="number" name="dias_anticipacion_compra_proveedor" id="dias_anticipacion_compra_proveedor" value="{{ request_form_data.dias_anticipacion_compra_proveedor or '' }}" min="0">
        </div>
    </fieldset>

    {# Sección de Atributos Descriptivos Adicionales #}
    <fieldset class="form-section">
        <legend><h4>Atributos Descriptivos Adicionales</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="sabor">Sabor:</label>
                <input type="text" name="sabor" id="sabor" value="{{ request_form_data.sabor or '' }}">
            </div>
            <div class="form-group">
                <label for="color">Color:</label>
                <input type="text" name="color" id="color" value="{{ request_form_data.color or '' }}">
            </div>
            <div class="form-group">
                <label for="tamano_pulgadas">Tamaño (Pulgadas):</label>
                <input type="text" name="tamano_pulgadas" id="tamano_pulgadas" value="{{ request_form_data.tamano_pulgadas or '' }}">
            </div>
            <div class="form-group">
                <label for="material">Material:</label>
                <input type="text" name="material" id="material" value="{{ request_form_data.material or '' }}">
            </div>
            <div class="form-group">
                <label for="dimensiones_capacidad">Dimensiones/Capacidad:</label>
                <input type="text" name="dimensiones_capacidad" id="dimensiones_capacidad" value="{{ request_form_data.dimensiones_capacidad or '' }}">
            </div>
             <div class="form-group">
                <label for="tema_estilo">Tema/Estilo:</label>
                <input type="text" name="tema_estilo" id="tema_estilo" value="{{ request_form_data.tema_estilo or '' }}">
            </div>
             <div class="form-group">
                <label for="forma_tipo">Forma/Tipo:</label>
                <input type="text" name="forma_tipo" id="forma_tipo" value="{{ request_form_data.forma_tipo or '' }}">
            </div>
            <div class="form-group">
                <label for="modalidad_servicio_directo">Modalidad (si es un servicio directo):</label>
                <input type="text" name="modalidad_servicio_directo" id="modalidad_servicio_directo" value="{{ request_form_data.modalidad_servicio_directo or '' }}">
            </div>
        </div>
    </fieldset>

    <div class="form-actions">
        {# CORREGIDO el url_for aquí #}
        <a href="{{ url_for('productos_bp.vista_listar_productos') }}" class="button button-secondary">Cancelar</a>
        <input type="submit" value="Crear Producto Interno" class="button button-primary">
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriaPrincipalSelect = document.getElementById('id_categoria_principal_producto');
    const subcategoriaEspecificaSelect = document.getElementById('id_subcategoria_especifica_producto');

    const todasLasSubcategoriasOptions = Array.from(subcategoriaEspecificaSelect.options).filter(opt => opt.value !== "");

    function filtrarSubcategorias() {
        const selectedCategoriaId = categoriaPrincipalSelect.value;
        let valorActualSubcategoria = subcategoriaEspecificaSelect.value;

        while (subcategoriaEspecificaSelect.options.length > 1) {
            subcategoriaEspecificaSelect.remove(1);
        }

        if (selectedCategoriaId) {
            todasLasSubcategoriasOptions.forEach(optionElement => {
                if (optionElement.dataset.idCategoriaContenedora === selectedCategoriaId) {
                    subcategoriaEspecificaSelect.add(optionElement.cloneNode(true));
                }
            });
        } else {
            todasLasSubcategoriasOptions.forEach(optionElement => {
                subcategoriaEspecificaSelect.add(optionElement.cloneNode(true));
            });
        }
        subcategoriaEspecificaSelect.value = valorActualSubcategoria;
        if (subcategoriaEspecificaSelect.selectedIndex === -1 || subcategoriaEspecificaSelect.value === "") {
             if (subcategoriaEspecificaSelect.options.length > 0) subcategoriaEspecificaSelect.options[0].selected = true;
        }
    }

    if (categoriaPrincipalSelect && subcategoriaEspecificaSelect) {
        categoriaPrincipalSelect.addEventListener('change', filtrarSubcategorias);
        filtrarSubcategorias();
    }
});
</script>

<style>
    .form-text.text-muted {
        font-size: 0.8em;
        color: #6c757d;
        display: block;
        margin-top: 4px;
    }
    .required-indicator {
        color: var(--color-peligro);
        font-weight: bold;
        margin-left: 2px;
    }
</style>
{% endblock %}
