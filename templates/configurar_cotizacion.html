{% extends "base.html" %}

{% block content %}
    <form method="POST" action="{{ url_for('cotizaciones_bp.vista_guardar_configuracion_cotizacion', id_proyecto=proyecto.id_proyecto, id_cotizacion=(cotizacion.id_cotizacion if cotizacion and cotizacion.id_cotizacion else None)) }}" class="styled-form" id="formConfigurarCotizacion">
        {# --- Sección 0: Información del Proyecto (Solo lectura) --- #}
        <fieldset class="form-section view-section" style="background-color: #f0f7ff;">
            <legend><h4>Proyecto Asociado</h4></legend>
            <div class="details-grid-cols-2">
                <div class="detail-item">
                    <span class="detail-label">Nombre del Evento:</span>
                    <span class="detail-value">
                        <a href="{{ url_for('proyectos_bp.vista_detalle_proyecto', id_proyecto=proyecto.id_proyecto) }}" target="_blank" title="Ver detalles completos del proyecto">
                            {{ proyecto.nombre_evento }}
                        </a>
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Identificador:</span>
                    <span class="detail-value">{{ proyecto.identificador_evento }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Fecha del Evento:</span>
                    <span class="detail-value">{{ proyecto.fecha_evento.strftime('%d/%m/%Y') if proyecto.fecha_evento else '-' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">No. Invitados (Proyecto):</span>
                    <span class="detail-value" id="proyecto_numero_invitados_display">{{ proyecto.numero_invitados or '-' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Cliente:</span>
                    <span class="detail-value">{{ proyecto.cliente_nombre or '-' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Tipo Ubicación:</span>
                    <span class="detail-value">{{ proyecto.tipo_ubicacion or 'Local' }}</span>
                </div>
            </div>
        </fieldset>

        {# --- Sección 1: Datos Generales de la Cotización --- #}
        <fieldset class="form-section">
            <legend><h4>Datos Generales de la Cotización</h4></legend>
            <input type="hidden" name="id_proyecto" value="{{ proyecto.id_proyecto }}">
            {% if cotizacion and cotizacion.id_cotizacion %}
                <input type="hidden" name="id_cotizacion" value="{{ cotizacion.id_cotizacion }}">
            {% endif %}

            <div class="form-grid-3col">
                <div class="form-group">
                    <label for="version">Versión:</label>
                    <input type="number" name="version" id="version"
                           value="{{ request.form.get('version', (cotizacion.version if cotizacion else 1)) }}"
                           min="1" required readonly class="form-control-disabled-visual">
                </div>
                <div class="form-group">
                    <label for="fecha_emision">Fecha de Emisión: <span class="required-indicator">*</span></label>
                    <input type="date" name="fecha_emision" id="fecha_emision"
                           value="{{ request.form.get('fecha_emision', (cotizacion.fecha_emision.isoformat() if cotizacion and cotizacion.fecha_emision else fecha_hoy)) }}"
                           required>
                </div>
                <div class="form-group">
                    <label for="fecha_validez">Válida Hasta (Opcional):</label>
                    <input type="date" name="fecha_validez" id="fecha_validez"
                           value="{{ request.form.get('fecha_validez', (cotizacion.fecha_validez.isoformat() if cotizacion and cotizacion.fecha_validez else '')) }}">
                </div>
            </div>
             <div class="form-grid-2col">
                <div class="form-group">
                    <label for="estado">Estado de la Cotización:</label>
                    <select name="estado" id="estado">
                        {% set current_estado = request.form.get('estado', (cotizacion.estado if cotizacion else 'Borrador')) %}
                        <option value="Borrador" {% if current_estado == 'Borrador' %}selected{% endif %}>Borrador</option>
                        <option value="Presentada" {% if current_estado == 'Presentada' %}selected{% endif %}>Presentada</option>
                        <option value="Aceptada" {% if current_estado == 'Aceptada' %}selected{% endif %}>Aceptada</option>
                        <option value="Rechazada" {% if current_estado == 'Rechazada' %}selected{% endif %}>Rechazada</option>
                        <option value="Cancelada" {% if current_estado == 'Cancelada' %}selected{% endif %}>Cancelada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="numero_invitados_cotizacion">Número de Invitados para esta Cotización:</label>
                    <input type="number" name="numero_invitados_cotizacion" id="numero_invitados_cotizacion"
                           value="{{ request.form.get('numero_invitados_cotizacion', (cotizacion.numero_invitados_override if cotizacion and cotizacion.numero_invitados_override is not none else proyecto.numero_invitados or 1)) }}"
                           min="1" required>
                    <small>Por defecto, toma los del proyecto. Modifica si es específico para esta cotización.</small>
                </div>
            </div>
        </fieldset>

        {# --- SECCIÓN: Configuración de Servicio Detallada --- #}
        <fieldset class="form-section">
            <legend><h4 id="configuradorServicioTitulo">Añadir Servicio Detallado</h4></legend>
            <input type="hidden" id="editing_item_idx" value=""> 
            <input type="hidden" id="editing_item_id_variante_config_original" value="">


            <p class="subtle-text">Selecciona un tipo de servicio, paquete y perfil para configurar sus componentes. Una vez configurado, podrás añadirlo como un ítem a la cotización.</p>

            <div class="form-grid-3col" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="select_tipo_servicio_base">1. Tipo de Servicio:</label>
                    <select id="select_tipo_servicio_base" class="form-control">
                        <option value="">-- Selecciona Tipo --</option>
                        {% for tsb in todos_tipos_servicio_base_activos %}
                            <option value="{{ tsb.id_tipo_servicio_base }}">{{ tsb.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="select_nivel_paquete">2. Nivel de Paquete:</label>
                    <select id="select_nivel_paquete" class="form-control" disabled>
                        <option value="">-- Selecciona Paquete --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="select_nivel_perfil">3. Nivel de Perfil:</label>
                    <select id="select_nivel_perfil" class="form-control" disabled>
                        <option value="">-- Selecciona Perfil --</option>
                    </select>
                </div>
            </div>

            <div id="info_variante_seleccionada" class="selected-product-info-box-compact" style="display:none; margin-bottom:15px; background-color: #e6fff3; border-color: #b3ffda;">
                Variante Seleccionada: <strong id="nombre_variante_display"></strong> (ID: <span id="id_variante_display"></span>)
            </div>
            
            <div id="config_invitados_para_servicio_actual_container" style="display:none; margin-top: 15px; margin-bottom:15px; padding:15px; border: 1px solid #e0e4e8; border-radius: var(--radio-borde-general); background-color: #f9fafb;">
                <h6 style="margin-top:0; margin-bottom:10px; font-weight:500;">Invitados para este Servicio Específico:</h6>
                <div class="form-group">
                    <label for="config_usar_invitados_generales_evento" class="checkbox-label-inline">
                        <input type="checkbox" id="config_usar_invitados_generales_evento" checked>
                        Aplicar invitados generales de la cotización (<span id="config_display_invitados_generales_evento">N/A</span>)
                    </label>
                </div>
                <div class="form-group" id="config_campo_invitados_especificos_servicio" style="display:none; margin-top: 8px;">
                    <label for="config_numero_invitados_este_servicio">Número de invitados para ESTE servicio:</label>
                    <input type="number" id="config_numero_invitados_este_servicio" min="1" class="form-control" style="width: 100px;">
                </div>
            </div>

            <div id="contenedor_grupos_columnas" class="opciones-servicio-container-columnas" style="display:none;">
            </div>
            <div id="acciones_servicio_configurable" style="margin-top: 20px; display:none;">
                 <button type="button" id="btnAnadirServicioConfiguradoComoItem" class="button button-primary">
                    Añadir este Servicio Configurado a la Cotización
                </button>
                 <button type="button" id="btnCancelarEdicionServicio" class="button button-secondary" style="display:none; margin-left:10px;">
                    Cancelar Edición
                </button>
            </div>
        </fieldset>


        {# --- Sección Ítems de la Cotización --- #}
        <fieldset class="form-section">
            <legend><h4>Ítems Actuales de la Cotización</h4></legend>
            <div id="items-cotizacion-container">
                {% if cotizacion and cotizacion.items_cotizacion %}
                    {% for item_cot_idx, item_cot in enumerate(cotizacion.items_cotizacion|sort(attribute='orden_display_cot')) %}
                        <div class="item-cotizacion-card" data-item-idx="{{ item_cot_idx }}">
                            <input type="hidden" name="items[{{ item_cot_idx }}][id_item_cotizacion]" value="{{ item_cot.id_item_cotizacion or '' }}">
                            <input type="hidden" name="items[{{ item_cot_idx }}][id_variante_servicio_config]" value="{{ item_cot.id_variante_servicio_config or '' }}">
                            <input type="hidden" name="items[{{ item_cot_idx }}][numero_invitados_servicio_item]" value="{{ item_cot.numero_invitados_servicio_item or (cotizacion.numero_invitados_override or proyecto.numero_invitados or 1) }}">

                            <div class="item-cotizacion-header">
                                <h5 class="item-nombre-display">
                                    <input type="text" name="items[{{ item_cot_idx }}][nombre_display_servicio]"
                                           value="{{ item_cot.nombre_display_servicio }}" placeholder="Nombre del Servicio/Paquete" class="input-inline-editable" required>
                                </h5>
                                <div> {# Contenedor para botones de acción del ítem #}
                                    <button type="button" class="button button-edit-black-small edit-item-cotizacion-btn" style="margin-right: 5px;">Editar</button>
                                    <button type="button" class="button button-danger-small remove-item-cotizacion-btn">Eliminar</button>
                                </div>
                            </div>
                            <div class="form-grid-2col">
                                <div class="form-group">
                                    <label>Cantidad del Servicio:</label>
                                    <input type="number" name="items[{{ item_cot_idx }}][cantidad_servicio]" value="{{ item_cot.cantidad_servicio|float if item_cot.cantidad_servicio is not none else 1.0 }}" min="0.1" step="any" class="input-cantidad-servicio">
                                </div>
                                <div class="form-group">
                                    <label>Precio Total Ítem:</label>
                                     <input type="number" step="0.01" name="items[{{ item_cot_idx }}][precio_total_item_calculado]"
                                       value="{{ '{:.2f}'.format(item_cot.precio_total_item_calculado|float) if item_cot.precio_total_item_calculado is not none else '0.00' }}"
                                       class="input-precio-item" readonly style="font-weight:bold; background-color:#e9ecef;">
                                </div>
                            </div>
                            <div class="form-group">
                                <small class="text-muted">Este servicio se calculará para <strong>{{ item_cot.numero_invitados_servicio_item or (cotizacion.numero_invitados_override or proyecto.numero_invitados or 1) }}</strong> invitados.</small>
                            </div>
                            <div class="form-group">
                                <label>Descripción (para el cliente):</label>
                                <textarea name="items[{{ item_cot_idx }}][descripcion_servicio_cotizado]" rows="2" class="input-descripcion-servicio">{{ item_cot.descripcion_servicio_cotizado or '' }}</textarea>
                            </div>

                            <div class="componentes-seleccionados-display-container">
                                <strong class="componentes-display-titulo">Componentes Incluidos:</strong>
                                {% if item_cot.componentes_seleccionados %}
                                <ul class="componentes-display-lista">
                                {% for comp_sel in item_cot.componentes_seleccionados %}
                                    <li class="componentes-display-item">
                                        {{ comp_sel.opcion_componente_elegida.nombre_display_cliente }}
                                        <span class="componente-cantidad-display">
                                            (Cant: {% if comp_sel.opcion_componente_elegida.producto_interno_ref and comp_sel.opcion_componente_elegida.producto_interno_ref.es_indivisible %}
                                                {{ comp_sel.cantidad_final_producto_interno_calc | round(0) if comp_sel.cantidad_final_producto_interno_calc is not none else 'N/A' }}
                                            {% else %}
                                                {{ comp_sel.cantidad_final_producto_interno_calc | round(1) if comp_sel.cantidad_final_producto_interno_calc is not none else 'N/A' }}
                                            {% endif %}
                                            {{ comp_sel.opcion_componente_elegida.producto_interno_ref.unidad_medida_base if comp_sel.opcion_componente_elegida.producto_interno_ref else comp_sel.opcion_componente_elegida.unidad_consumo_base }})
                                        </span>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% else %}
                                <p class="componentes-display-none"><em>Este ítem no tiene componentes detallados o es un servicio personalizado.</em></p>
                                {% endif %}
                                {% for comp_idx, comp_sel in enumerate(item_cot.componentes_seleccionados) %}
                                    <input type="hidden" name="items[{{ item_cot_idx }}][componentes][{{ comp_idx }}][id_opcion_componente]" value="{{ comp_sel.id_opcion_componente }}">
                                    <input type="hidden" name="items[{{ item_cot_idx }}][componentes][{{ comp_idx }}][cantidad_opcion_solicitada_cliente]" value="{{ comp_sel.cantidad_opcion_solicitada_cliente }}">
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <p id="noItemsCotizacionMessage" style="text-align:center; padding:10px; {% if cotizacion is none or not cotizacion.items_cotizacion %}display:block;{% else %}display:none;{% endif %}">
                Aún no has añadido ítems a esta cotización. Configura un servicio detallado arriba y añádelo.
            </p>
        </fieldset>

        {# --- Sección 3: Costos Logísticos y Totales --- #}
        <fieldset class="form-section">
            <legend><h4>Costos Logísticos y Totales de la Cotización</h4></legend>
            <div class="form-grid-3col">
                <div class="form-group">
                    <label for="monto_costos_logisticos">Costos Logísticos Adicionales ($):</label>
                    <input type="number" step="0.01" name="monto_costos_logisticos" id="monto_costos_logisticos"
                           value="{{ request.form.get('monto_costos_logisticos', '{:.2f}'.format(cotizacion.monto_costos_logisticos|float if cotizacion and cotizacion.monto_costos_logisticos is not none else (proyecto.costo_transporte_estimado or 0)|float + (proyecto.costo_viaticos_estimado or 0)|float + (proyecto.costo_hospedaje_estimado or 0)|float)) }}"
                           min="0">
                </div>
                <div class="form-group">
                    <label for="porcentaje_descuento_global">Descuento Global (%):</label>
                    <input type="number" step="0.01" name="porcentaje_descuento_global" id="porcentaje_descuento_global"
                           value="{{ request.form.get('porcentaje_descuento_global', '{:.2f}'.format(cotizacion.porcentaje_descuento_global|float if cotizacion and cotizacion.porcentaje_descuento_global is not none else 0.00)) }}"
                           min="0" max="100">
                    <input type="hidden" name="monto_descuento_global_calculado" id="monto_descuento_global_calculado" value="{{ '{:.2f}'.format(cotizacion.monto_descuento_global|float) if cotizacion and cotizacion.monto_descuento_global is not none else '0.00' }}">
                </div>
                <div class="form-group">
                    <label for="porcentaje_impuestos">Impuestos (ej. IVA %):</label>
                    <input type="number" step="0.01" name="porcentaje_impuestos" id="porcentaje_impuestos"
                           value="{{ request.form.get('porcentaje_impuestos', '{:.2f}'.format(cotizacion.porcentaje_impuestos|float if cotizacion and cotizacion.porcentaje_impuestos is not none else 16.00)) }}"
                           min="0">
                    <input type="hidden" name="monto_impuestos_calculado" id="monto_impuestos_calculado" value="{{ '{:.2f}'.format(cotizacion.monto_impuestos|float) if cotizacion and cotizacion.monto_impuestos is not none else '0.00' }}">
                </div>
            </div>
            <hr style="margin: 20px 0;">
            <div class="resumen-totales" style="text-align: right; font-size: 1.1em;">
                <p>Subtotal Servicios/Productos: <strong id="displaySubtotalServicios">$0.00</strong></p>
                <p>Subtotal General (con Logística): <strong id="displaySubtotalGeneral">$0.00</strong></p>
                <p style="color: var(--color-peligro);">Menos Descuento Global: <strong id="displayDescuentoGlobal">-$0.00</strong></p>
                <p>Más Impuestos: <strong id="displayImpuestos">+$0.00</strong></p>
                <h4 style="margin-top:10px; font-size: 1.3em;">TOTAL COTIZADO: <strong id="displayTotalCotizado" style="color: var(--color-acento-secundario);">$0.00</strong></h4>
            </div>
        </fieldset>

        {# --- Sección 4: Términos y Notas --- #}
         <fieldset class="form-section">
            <legend><h4>Términos, Condiciones y Notas Adicionales</h4></legend>
            <div class="form-group">
                <label for="terminos_condiciones">Términos y Condiciones:</label>
                <textarea name="terminos_condiciones" id="terminos_condiciones" rows="4">{{ request.form.get('terminos_condiciones', cotizacion.terminos_condiciones if cotizacion else '') }}</textarea>
            </div>
            <div class="form-group">
                <label for="notas_cotizacion">Notas Internas de la Cotización (no visibles al cliente):</label>
                <textarea name="notas_cotizacion" id="notas_cotizacion" rows="2">{{ request.form.get('notas_cotizacion', cotizacion.notas_cotizacion if cotizacion else '') }}</textarea>
            </div>
        </fieldset>

        <div class="form-actions">
            <a href="{{ url_for('cotizaciones_bp.vista_listar_cotizaciones_por_proyecto', id_proyecto=proyecto.id_proyecto) }}" class="button button-secondary">Cancelar y Volver al Proyecto</a>
            <button type="submit" name="accion" value="guardar_borrador" class="button button-secondary">Guardar Borrador</button>
            <button type="submit" name="accion" value="guardar_finalizar" class="button button-primary">
                {{ 'Actualizar Cotización' if cotizacion and cotizacion.id_cotizacion else 'Finalizar y Guardar Cotización' }}
            </button>
        </div>
    </form>

<style>
    /* ... (Estilos existentes de configurar_cotizacion.html) ... */
    .button-edit-black-small { 
        background-color: var(--color-texto-principal);
        color: white;
        padding: 4px 8px;
        font-size: 0.8em;
        border-radius: var(--radio-borde-general);
        text-decoration: none;
        border: 1px solid var(--color-texto-principal);
        transition: background-color 0.2s ease, opacity 0.2s ease;
    }
    .button-edit-black-small:hover {
        background-color: #333;
        opacity: 0.9;
    }
    .opciones-servicio-container-columnas {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: var(--radio-borde-general);
        margin-top: 15px;
        background-color: #fdfdfd;
    }
    .grupo-columna {
        flex-basis: 280px;
        flex-grow: 1;
        padding: 15px;
        border: 1px solid #d1d5db;
        border-radius: var(--radio-borde-general);
        background-color: #ffffff;
        box-shadow: var(--sombra-caja-ligera);
    }
    .grupo-columna h6 {
        font-size: 1.05em;
        font-weight: 600;
        color: var(--color-texto-principal);
        margin-top: 0;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--color-borde-sutil);
    }
    .grupo-columna .opcion-checkbox-item {
        display: block;
        margin-bottom: 10px;
    }
    .grupo-columna .opcion-checkbox-item label {
        font-size: 0.9em;
        color: var(--color-texto-secundario);
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"] {
        margin-right: 8px;
        height: 16px;
        width: 16px;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"]:disabled + span {
        color: #b0b0b0;
        text-decoration: line-through;
    }
    .grupo-columna .opcion-checkbox-item label:has(input[type="checkbox"]:disabled) {
        cursor: not-allowed;
        opacity: 0.6;
    }
    .subtle-text { font-size: 0.9em; color: var(--color-texto-secundario); line-height: 1.5; }

    .item-cotizacion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px; 
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .item-cotizacion-header .item-nombre-display { 
        margin: 0;
        flex-grow: 1;
        font-size: 1.1em; 
        font-weight: 600;
        color: var(--color-texto-principal);
    }
    .input-inline-editable { 
        border: none;
        background-color: transparent;
        padding: 2px 5px; 
        font-size: inherit; 
        font-weight: inherit; 
        color: inherit; 
        width: calc(100% - 10px); 
        box-shadow: none; 
    }
    .input-inline-editable:focus {
        background-color: #f0f8ff; 
        border: 1px solid var(--color-borde-input);
        box-shadow: none;
    }
    .button.button-danger-small.remove-item-cotizacion-btn { 
        background-color: var(--color-peligro);
        color: white;
        border: 1px solid var(--color-peligro);
        padding: 6px 12px; 
        font-size: 0.85em;
    }
    .button.button-danger-small.remove-item-cotizacion-btn:hover {
        background-color: #c82333; 
        border-color: #bd2130;
    }

    .componentes-seleccionados-display-container {
        margin-top: 15px;
        padding: 12px 15px; 
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: var(--radio-borde-general);
        font-size: 0.9em;
    }
    .componentes-display-titulo {
        display: block;
        font-weight: 600;
        color: var(--color-texto-principal);
        margin-bottom: 8px;
        font-size: 0.95em; 
    }
    .componentes-display-lista {
        list-style-type: none;
        padding-left: 0;
        margin-bottom: 0;
    }
    .componentes-display-item {
        padding: 5px 0; 
        color: var(--color-texto-secundario);
        border-bottom: 1px dotted #e0e0e0;
        display: flex; 
        justify-content: space-between; 
        align-items: center;
    }
    .componentes-display-item:last-child {
        border-bottom: none;
    }
    .componente-cantidad-display {
        font-size: 0.9em;
        color: #555; 
        background-color: #e9ecef; 
        padding: 2px 6px;
        border-radius: 4px;
    }
    .componentes-display-none {
        color: #777;
        font-style: italic;
        padding: 5px 0;
    }
    .checkbox-label-inline { 
        display: flex;
        align-items: center;
        font-weight: normal !important;
        font-size: 0.9em !important;
    }
    .checkbox-label-inline input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(0.9); 
    }
</style>

<script id="todas_variantes_config_json" type="application/json">
    {{ todas_variantes_config | tojson | safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectTipoServicio = document.getElementById('select_tipo_servicio_base');
    const selectNivelPaquete = document.getElementById('select_nivel_paquete');
    const selectNivelPerfil = document.getElementById('select_nivel_perfil');
    const infoVarianteDiv = document.getElementById('info_variante_seleccionada');
    const nombreVarianteDisplay = document.getElementById('nombre_variante_display');
    const idVarianteDisplay = document.getElementById('id_variante_display');
    
    const configInvitadosServicioContainerEl = document.getElementById('config_invitados_para_servicio_actual_container');
    const chkUsarInvitadosGeneralesEventoEl = document.getElementById('config_usar_invitados_generales_evento');
    const displayInvitadosGeneralesEventoEl = document.getElementById('config_display_invitados_generales_evento');
    const campoInvitadosEspecificosServicioEl = document.getElementById('config_campo_invitados_especificos_servicio');
    const inputNumeroInvitadosEsteServicioEl = document.getElementById('config_numero_invitados_este_servicio');
    const inputNumeroInvitadosCotizacionEl = document.getElementById('numero_invitados_cotizacion');
    
    const contenedorGruposColumnas = document.getElementById('contenedor_grupos_columnas');
    const accionesServicioConfigurableDiv = document.getElementById('acciones_servicio_configurable');
    const btnAnadirServicioConfigurado = document.getElementById('btnAnadirServicioConfiguradoComoItem');
    const itemsCotizacionContainer = document.getElementById('items-cotizacion-container');
    const noItemsMessage = document.getElementById('noItemsCotizacionMessage');
    
    let itemCotizacionIndex = document.querySelectorAll('#items-cotizacion-container .item-cotizacion-card').length;
    let currentConfiguredVariant = null;
    let currentConfiguredVariantEstructura = null;

    let isEditingItemMode = false;
    let editingItemCard = null; 
    let componentesParaEditar = [];
    const configuradorServicioTitulo = document.getElementById('configuradorServicioTitulo');
    const btnCancelarEdicionServicio = document.getElementById('btnCancelarEdicionServicio');
    const editingItemIdxInput = document.getElementById('editing_item_idx');
    const editingItemIdVarianteOriginalInput = document.getElementById('editing_item_id_variante_config_original');

    let todasVariantesJS = [];
    const variantesJsonScript = document.getElementById('todas_variantes_config_json');
    if (variantesJsonScript) {
        try {
            todasVariantesJS = JSON.parse(variantesJsonScript.textContent);
        } catch (e) {
            console.error("Error parseando JSON de variantes:", e);
        }
    }

    const inputPorcentajeDescuento = document.getElementById('porcentaje_descuento_global');
    const inputMontoDescuentoCalculado = document.getElementById('monto_descuento_global_calculado');
    const inputPorcentajeImpuestos = document.getElementById('porcentaje_impuestos');
    const inputMontoImpuestosCalculado = document.getElementById('monto_impuestos_calculado');


    function populateSelect(selectElement, options, placeholder) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        if (options && Array.isArray(options)) { 
            options.forEach(option => {
                const value = typeof option === 'object' ? option.id : option;
                const text = typeof option === 'object' ? option.nombre : option;
                selectElement.add(new Option(text, value));
            });
        }
        selectElement.disabled = !(options && options.length > 0);
    }

    function resetServiceConfigurator(clearMainSelects = true) {
        if(clearMainSelects){
            if(selectTipoServicio) { selectTipoServicio.value = ""; selectTipoServicio.disabled = false; }
            if(selectNivelPaquete) { populateSelect(selectNivelPaquete, [], '-- Selecciona Paquete --'); selectNivelPaquete.disabled = true;}
            if(selectNivelPerfil) { populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --'); selectNivelPerfil.disabled = true;}
        }
        // Siempre habilitar los selects al resetear, a menos que se entre en modo edición inmediatamente después
        if(selectTipoServicio) selectTipoServicio.disabled = false;
        if(selectNivelPaquete) selectNivelPaquete.disabled = true; // Paquete se habilita al seleccionar tipo
        if(selectNivelPerfil) selectNivelPerfil.disabled = true;   // Perfil se habilita al seleccionar paquete


        if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
        if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
        if(contenedorGruposColumnas) {
            contenedorGruposColumnas.style.display = 'none';
            contenedorGruposColumnas.innerHTML = '';
        }
        if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
        
        currentConfiguredVariant = null;
        currentConfiguredVariantEstructura = null;
        
        isEditingItemMode = false;
        editingItemCard = null;
        componentesParaEditar = [];
        if(configuradorServicioTitulo) configuradorServicioTitulo.textContent = "Añadir Servicio Detallado";
        if(btnAnadirServicioConfigurado) btnAnadirServicioConfigurado.textContent = "Añadir este Servicio Configurado a la Cotización";
        if(btnCancelarEdicionServicio) btnCancelarEdicionServicio.style.display = 'none';
        if(editingItemIdxInput) editingItemIdxInput.value = "";
        if(editingItemIdVarianteOriginalInput) editingItemIdVarianteOriginalInput.value = "";
    }

    if(btnCancelarEdicionServicio){
        btnCancelarEdicionServicio.addEventListener('click', function(){
            resetServiceConfigurator(true); 
        });
    }

    async function fetchAndPopulate(selectElement, url, placeholder, dependentActionCallback = null) {
        if (!selectElement) return;
        populateSelect(selectElement, [], placeholder); 
        selectElement.disabled = true;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error API: ${response.status}`);
            const data = await response.json();
            populateSelect(selectElement, data, placeholder);
            if (dependentActionCallback) await dependentActionCallback(); 
        } catch (error) {
            console.error(`Error fetching para ${selectElement.id}:`, error);
            populateSelect(selectElement, [], placeholder); 
        }
    }
    
    if (selectTipoServicio) {
        selectTipoServicio.addEventListener('change', async function() {
            const tipoBaseId = this.value;
            // No resetear todo el configurador si solo cambia el tipo y no estamos en modo edición forzada
            if (!isEditingItemMode) { 
                 resetServiceConfigurator(false); // false para no limpiar este select
            }
            populateSelect(selectNivelPaquete, [], '-- Selecciona Paquete --');
            selectNivelPaquete.disabled = true;
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            selectNivelPerfil.disabled = true;

            if (tipoBaseId) {
                await fetchAndPopulate(
                    selectNivelPaquete,
                    `{{ url_for('admin_servicios_bp.api_get_niveles_paquete') }}?id_tipo_base=${tipoBaseId}`,
                    '-- Selecciona Paquete --',
                    async () => { 
                        if (isEditingItemMode && editingItemCard) {
                            const idVarianteActual = editingItemIdVarianteOriginalInput.value;
                            const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);
                            // Solo preseleccionar paquete si el tipo de servicio coincide con el de la variante original
                            if (varianteObjActual && varianteObjActual.id_tipo_servicio_base == tipoBaseId && Array.from(selectNivelPaquete.options).map(o=>o.value).includes(String(varianteObjActual.nivel_paquete))) {
                                selectNivelPaquete.value = varianteObjActual.nivel_paquete;
                                selectNivelPaquete.disabled = true; 
                                await selectNivelPaquete.dispatchEvent(new Event('change'));
                            } else if (isEditingItemMode) { 
                                // Si el tipo no coincide, no podemos preseleccionar paquete, mantener deshabilitado
                                selectNivelPaquete.disabled = true;
                            }
                        }
                    }
                );
            }
        });
    }

    if (selectNivelPaquete) {
        selectNivelPaquete.addEventListener('change', async function() {
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = this.value;
            
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            selectNivelPerfil.disabled = true;
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
            if(contenedorGruposColumnas) { contenedorGruposColumnas.style.display = 'none'; contenedorGruposColumnas.innerHTML = '';}
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null; currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre) {
                 await fetchAndPopulate(
                    selectNivelPerfil,
                    `{{ url_for('admin_servicios_bp.api_get_niveles_perfil') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}`,
                    '-- Selecciona Perfil --',
                    async () => { 
                        if (isEditingItemMode && editingItemCard) {
                            const idVarianteActual = editingItemIdVarianteOriginalInput.value;
                            const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);
                            if (varianteObjActual && varianteObjActual.nivel_paquete == paqueteNombre && Array.from(selectNivelPerfil.options).map(o=>o.value).includes(String(varianteObjActual.nivel_perfil))) {
                                selectNivelPerfil.value = varianteObjActual.nivel_perfil;
                                selectNivelPerfil.disabled = true; 
                                await selectNivelPerfil.dispatchEvent(new Event('change'));
                            } else if (isEditingItemMode) {
                                selectNivelPerfil.disabled = true;
                            }
                        }
                    }
                );
            }
        });
    }

    if (selectNivelPerfil) {
        selectNivelPerfil.addEventListener('change', async function() {
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = selectNivelPaquete.value;
            const perfilNombre = this.value;
            
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
            if(contenedorGruposColumnas) { contenedorGruposColumnas.style.display = 'none'; contenedorGruposColumnas.innerHTML = '';}
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null; currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre && perfilNombre) {
                try {
                    const response = await fetch(`{{ url_for('admin_servicios_bp.api_buscar_variante_por_niveles') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}&perfil=${encodeURIComponent(perfilNombre)}`);
                    if (!response.ok) throw new Error('Variante no encontrada o error en API');
                    const varianteData = await response.json();

                    if (varianteData && varianteData.id_variante_config) {
                        currentConfiguredVariant = varianteData; 
                        if(nombreVarianteDisplay) nombreVarianteDisplay.textContent = varianteData.nombre_variante;
                        if(idVarianteDisplay) idVarianteDisplay.textContent = varianteData.id_variante_config;
                        if(infoVarianteDiv) infoVarianteDiv.style.display = 'block';
                        
                        if (configInvitadosServicioContainerEl) {
                            const numInvCotizacion = inputNumeroInvitadosCotizacionEl ? (inputNumeroInvitadosCotizacionEl.value.trim() || '1') : '1';
                            if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvCotizacion;
                            
                            if (isEditingItemMode && editingItemCard) { 
                                const numInvitadosItemActual = parseInt(editingItemCard.querySelector(`input[name$="[numero_invitados_servicio_item]"]`).value);
                                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvitadosItemActual;
                                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = (numInvitadosItemActual == parseInt(numInvCotizacion));
                            } else { 
                                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvCotizacion;
                                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = true;
                            }
                            if(chkUsarInvitadosGeneralesEventoEl && campoInvitadosEspecificosServicioEl) {
                                campoInvitadosEspecificosServicioEl.style.display = chkUsarInvitadosGeneralesEventoEl.checked ? 'none' : 'block';
                            }
                            configInvitadosServicioContainerEl.style.display = 'block';
                        }
                        await cargarEstructuraVariante(varianteData.id_variante_config, isEditingItemMode ? componentesParaEditar : []);
                    } else {
                        if(infoVarianteDiv) {
                            infoVarianteDiv.innerHTML = '<p style="color:red;">No se encontró una variante de servicio para esta combinación.</p>';
                            infoVarianteDiv.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Error buscando variante:", error);
                    if(infoVarianteDiv) {
                        infoVarianteDiv.innerHTML = `<p style="color:red;">Error al buscar variante: ${error.message}</p>`;
                        infoVarianteDiv.style.display = 'block';
                    }
                }
            }
        });
    }

    if (chkUsarInvitadosGeneralesEventoEl && campoInvitadosEspecificosServicioEl && inputNumeroInvitadosEsteServicioEl && inputNumeroInvitadosCotizacionEl) {
        chkUsarInvitadosGeneralesEventoEl.addEventListener('change', function() {
            const numInvCotizacion = inputNumeroInvitadosCotizacionEl.value.trim() || '1';
            if (this.checked) {
                campoInvitadosEspecificosServicioEl.style.display = 'none';
                inputNumeroInvitadosEsteServicioEl.value = numInvCotizacion;
            } else {
                campoInvitadosEspecificosServicioEl.style.display = 'block';
                inputNumeroInvitadosEsteServicioEl.focus();
            }
        });
        inputNumeroInvitadosCotizacionEl.addEventListener('input', function() {
            const numInvCot = this.value.trim() || '1';
            if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvCot;
            if (chkUsarInvitadosGeneralesEventoEl.checked && inputNumeroInvitadosEsteServicioEl) {
                inputNumeroInvitadosEsteServicioEl.value = numInvCot;
            }
        });
        const numInvCotizacionInicial = inputNumeroInvitadosCotizacionEl.value.trim() || '1';
        if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvCotizacionInicial;
        if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvCotizacionInicial;
    }

    async function cargarEstructuraVariante(idVariante, componentesASeleccionar = []) {
        try {
            const response = await fetch(`{{ url_for('admin_servicios_bp.api_get_estructura_variante') }}?id_variante_config=${idVariante}`);
            if (!response.ok) throw new Error('Error al cargar estructura de la variante');
            currentConfiguredVariantEstructura = await response.json();

            renderizarGruposEnColumnas(currentConfiguredVariantEstructura.grupos);
            
            if (componentesASeleccionar.length > 0) {
                componentesASeleccionar.forEach(idOpcionComp => {
                    const checkbox = contenedorGruposColumnas.querySelector(`input[type="checkbox"][value="${idOpcionComp}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            aplicarLogicaCheckboxesDinamicos(); 

            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'block';
            if(contenedorGruposColumnas) contenedorGruposColumnas.style.display = 'flex';
        } catch (error) {
            console.error("Error cargando estructura variante:", error);
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.innerHTML = `<p style="color:red;">Error al cargar opciones: ${error.message}</p>`;
                contenedorGruposColumnas.style.display = 'block';
            }
             if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
        }
    }

    function renderizarGruposEnColumnas(grupos) {
        if(!contenedorGruposColumnas) return;
        contenedorGruposColumnas.innerHTML = '';
        if (!grupos || grupos.length === 0) {
            contenedorGruposColumnas.innerHTML = '<p>Esta variante no tiene grupos de componentes configurados.</p>';
            return;
        }

        grupos.forEach(grupo => {
            const divColumnaGrupo = document.createElement('div');
            divColumnaGrupo.classList.add('grupo-columna');
            divColumnaGrupo.dataset.idGrupo = grupo.id_grupo_config;
            divColumnaGrupo.dataset.opcionesPermitidas = grupo.opciones_permitidas_seleccionables;

            const h6 = document.createElement('h6');
            h6.textContent = `${grupo.nombre_grupo} (Elige ${grupo.opciones_permitidas_seleccionables})`;
            divColumnaGrupo.appendChild(h6);

            if (grupo.opciones_disponibles && grupo.opciones_disponibles.length > 0) {
                grupo.opciones_disponibles.forEach(opcion => {
                    const divOpcion = document.createElement('div');
                    divOpcion.classList.add('opcion-checkbox-item');
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `grupo_opcion_${grupo.id_grupo_config}`;
                    checkbox.value = opcion.id_opcion_componente;
                    checkbox.dataset.nombreOpcion = opcion.nombre_display_cliente;
                    checkbox.dataset.cantidadConsumoBase = opcion.cantidad_consumo_base;
                    checkbox.dataset.unidadConsumoBase = opcion.unidad_consumo_base;
                    checkbox.dataset.idProductoInterno = opcion.producto_info ? opcion.producto_info.id_producto_interno : '';
                    checkbox.dataset.unidadProductoBase = opcion.producto_info ? opcion.producto_info.unidad_medida_base : opcion.unidad_consumo_base;
                    checkbox.dataset.productoEsIndivisible = opcion.producto_info ? opcion.producto_info.es_indivisible : (opcion.unidad_consumo_base === 'pieza');

                    const span = document.createElement('span');
                    span.textContent = ` ${opcion.nombre_display_cliente} (${opcion.cantidad_consumo_base} ${opcion.unidad_consumo_base})`;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    divOpcion.appendChild(label);
                    divColumnaGrupo.appendChild(divOpcion);
                });
            } else {
                divColumnaGrupo.innerHTML += '<p class="text-xs text-gray-500">No hay opciones en este grupo.</p>';
            }
            contenedorGruposColumnas.appendChild(divColumnaGrupo);
        });
    }

    function aplicarLogicaCheckboxesDinamicos() {
        document.querySelectorAll('#contenedor_grupos_columnas .grupo-columna').forEach(grupoDiv => {
            const checkboxesEnGrupo = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]'));
            const maxSeleccionables = parseInt(grupoDiv.dataset.opcionesPermitidas);
            checkboxesEnGrupo.forEach(checkbox => {
                checkbox.addEventListener('change', () => { 
                    const seleccionadosActual = checkboxesEnGrupo.filter(cb => cb.checked).length;
                    if (seleccionadosActual >= maxSeleccionables) {
                        checkboxesEnGrupo.forEach(cb => {
                            if (!cb.checked) {
                                cb.disabled = true;
                                cb.closest('label').classList.add('opacity-60', 'cursor-not-allowed');
                            }
                        });
                    } else {
                        checkboxesEnGrupo.forEach(cb => {
                            cb.disabled = false;
                            cb.closest('label').classList.remove('opacity-60', 'cursor-not-allowed');
                        });
                    }
                });
                checkbox.dispatchEvent(new Event('change')); 
            });
        });
    }
    
    async function handleEditItemClick(itemCardToEdit) {
        editingItemCard = itemCardToEdit;
        isEditingItemMode = true;
        if(configuradorServicioTitulo) configuradorServicioTitulo.textContent = "Editando Componentes/Invitados del Servicio";
        if(btnAnadirServicioConfigurado) btnAnadirServicioConfigurado.textContent = "Actualizar Componentes/Invitados";
        if(btnCancelarEdicionServicio) btnCancelarEdicionServicio.style.display = 'inline-block';
        if(editingItemIdxInput) editingItemIdxInput.value = itemCardToEdit.dataset.itemIdx;

        const idVarianteActual = editingItemCard.querySelector(`input[name$="[id_variante_servicio_config]"]`).value;
        if(editingItemIdVarianteOriginalInput) editingItemIdVarianteOriginalInput.value = idVarianteActual;

        const numInvitadosItemActual = parseInt(editingItemCard.querySelector(`input[name$="[numero_invitados_servicio_item]"]`).value);
        componentesParaEditar = Array.from(editingItemCard.querySelectorAll(`input[name^="items[${itemCardToEdit.dataset.itemIdx}][componentes]"][name$="[id_opcion_componente]"]`)).map(inp => inp.value);

        const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);

        if (varianteObjActual) {
            selectTipoServicio.value = varianteObjActual.id_tipo_servicio_base;
            selectTipoServicio.disabled = true;
            
            await fetchAndPopulate(selectNivelPaquete, `{{ url_for('admin_servicios_bp.api_get_niveles_paquete') }}?id_tipo_base=${varianteObjActual.id_tipo_servicio_base}`, '-- Selecciona Paquete --');
            selectNivelPaquete.value = varianteObjActual.nivel_paquete;
            selectNivelPaquete.disabled = true;

            await fetchAndPopulate(selectNivelPerfil, `{{ url_for('admin_servicios_bp.api_get_niveles_perfil') }}?id_tipo_base=${varianteObjActual.id_tipo_servicio_base}&paquete=${encodeURIComponent(varianteObjActual.nivel_paquete)}`, '-- Selecciona Perfil --');
            selectNivelPerfil.value = varianteObjActual.nivel_perfil;
            selectNivelPerfil.disabled = true;
            
            currentConfiguredVariant = varianteObjActual; 
            if(nombreVarianteDisplay) nombreVarianteDisplay.textContent = varianteObjActual.nombre_variante;
            if(idVarianteDisplay) idVarianteDisplay.textContent = varianteObjActual.id_variante_config;
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'block';

            if (configInvitadosServicioContainerEl) {
                const numInvCotizacion = inputNumeroInvitadosCotizacionEl ? (inputNumeroInvitadosCotizacionEl.value.trim() || '1') : '1';
                if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvCotizacion;
                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvitadosItemActual;
                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = (numInvitadosItemActual == parseInt(numInvCotizacion));
                if(campoInvitadosEspecificosServicioEl) campoInvitadosEspecificosServicioEl.style.display = chkUsarInvitadosGeneralesEventoEl.checked ? 'none' : 'block';
                configInvitadosServicioContainerEl.style.display = 'block';
            }
            await cargarEstructuraVariante(idVarianteActual, componentesParaEditar);
        } else {
            alert("No se pudo encontrar la configuración de la variante para este ítem. No se pueden bloquear los selectores.");
            resetServiceConfigurator(true); 
        }
    }


    if (btnAnadirServicioConfigurado) {
        btnAnadirServicioConfigurado.addEventListener('click', function() {
            const idVarianteParaUsar = isEditingItemMode ? editingItemIdVarianteOriginalInput.value : (currentConfiguredVariant ? currentConfiguredVariant.id_variante_config : null);
            const nombreVarianteParaUsar = isEditingItemMode ? (editingItemCard.querySelector('.item-nombre-display input') ? editingItemCard.querySelector('.item-nombre-display input').value : "Servicio Editado") : (currentConfiguredVariant ? currentConfiguredVariant.nombre_variante : "Servicio Desconocido");
            const precioEstimadoOriginal = isEditingItemMode ? parseFloat(editingItemCard.querySelector('.input-precio-item').value) : (currentConfiguredVariant ? (currentConfiguredVariant.precio_base_sugerido || 0.00) : 0.00);


            if (!idVarianteParaUsar || !currentConfiguredVariantEstructura) {
                 alert("Por favor, selecciona y configura un servicio completamente primero (Tipo, Paquete, Perfil) o asegúrate de que el servicio a editar esté cargado.");
                return;
            }

            let numeroInvitadosParaEsteServicio;
            if (chkUsarInvitadosGeneralesEventoEl && chkUsarInvitadosGeneralesEventoEl.checked) {
                const numInvCotizacionVal = inputNumeroInvitadosCotizacionEl ? (inputNumeroInvitadosCotizacionEl.value.trim() || '1') : '1';
                numeroInvitadosParaEsteServicio = parseInt(numInvCotizacionVal);
            } else if (inputNumeroInvitadosEsteServicioEl) {
                numeroInvitadosParaEsteServicio = parseInt(inputNumeroInvitadosEsteServicioEl.value) || 1;
            } else {
                numeroInvitadosParaEsteServicio = parseInt(document.getElementById('numero_invitados_cotizacion').value) || 1;
            }
            if (numeroInvitadosParaEsteServicio < 1) numeroInvitadosParaEsteServicio = 1;

            const componentesSeleccionadosParaItem = [];
            let detalleHtmlComponentes = '';
            const totalGruposDisponiblesEnVariante = currentConfiguredVariantEstructura.grupos.length;
            let numeroDeGruposConSeleccionesEnVariante = 0;

            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (grupoDiv && grupoDiv.querySelectorAll('input[type="checkbox"]:checked').length > 0) {
                    numeroDeGruposConSeleccionesEnVariante++;
                }
            });

            let factorAjusteGlobalDeGrupos = 1.0;
            if (numeroDeGruposConSeleccionesEnVariante > 0 && numeroDeGruposConSeleccionesEnVariante < totalGruposDisponiblesEnVariante) {
                factorAjusteGlobalDeGrupos = totalGruposDisponiblesEnVariante / numeroDeGruposConSeleccionesEnVariante;
            }

            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (!grupoDiv) return;
                const opcionesPermitidasEnGrupo = parseInt(grupoDiv.dataset.opcionesPermitidas);
                const checkboxesSeleccionados = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]:checked'));
                const numOpcionesRealmenteElegidasEnGrupo = checkboxesSeleccionados.length;
                if (numOpcionesRealmenteElegidasEnGrupo === 0) return;
                const factorAjusteIntraGrupo = opcionesPermitidasEnGrupo / numOpcionesRealmenteElegidasEnGrupo;

                checkboxesSeleccionados.forEach(chk => {
                    const opcionOriginal = grupo.opciones_disponibles.find(o => o.id_opcion_componente == chk.value);
                    if (!opcionOriginal) return;
                    let cantidadConsumoBase = parseFloat(opcionOriginal.cantidad_consumo_base);
                    let cantidadAjustadaPorPersonaBruta = cantidadConsumoBase * factorAjusteIntraGrupo * factorAjusteGlobalDeGrupos;
                    let cantidadAjustadaPersonaFinal;
                    let unidadFinal = opcionOriginal.producto_info ? opcionOriginal.producto_info.unidad_medida_base : opcionOriginal.unidad_consumo_base;
                    let esIndivisible = opcionOriginal.producto_info ? opcionOriginal.producto_info.es_indivisible : (unidadFinal === 'pieza');

                    if (esIndivisible) {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta);
                    } else {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta / 5) * 5;
                         if (cantidadAjustadaPersonaFinal < cantidadAjustadaPorPersonaBruta) {
                             cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta / 5.000001) * 5;
                        }
                    }
                    let cantidadTotalEventoFinal = cantidadAjustadaPersonaFinal * numeroInvitadosParaEsteServicio; 
                    let cantFinalDisplay = esIndivisible ? cantidadTotalEventoFinal.toFixed(0) : (cantidadTotalEventoFinal % 1 === 0 ? cantidadTotalEventoFinal.toFixed(0) : cantidadTotalEventoFinal.toFixed(1));

                    detalleHtmlComponentes += `<li class="componentes-display-item">${opcionOriginal.nombre_display_cliente} <span class="componente-cantidad-display">(Cant: ${cantFinalDisplay} ${unidadFinal})</span></li>`;
                    componentesSeleccionadosParaItem.push({
                        id_opcion_componente: opcionOriginal.id_opcion_componente,
                        cantidad_opcion_solicitada_cliente: "1", 
                    });
                });
            });

            if (componentesSeleccionadosParaItem.length === 0 && currentConfiguredVariantEstructura.grupos.length > 0) {
                alert("Debes seleccionar al menos una opción de algún grupo para añadir el servicio, si la variante tiene grupos configurados.");
                return;
            }
            
            if (isEditingItemMode && editingItemCard) {
                const idx = editingItemCard.dataset.itemIdx;
                editingItemCard.querySelector(`input[name="items[${idx}][id_variante_servicio_config]"]`).value = idVarianteParaUsar;
                editingItemCard.querySelector(`input[name="items[${idx}][numero_invitados_servicio_item]"]`).value = numeroInvitadosParaEsteServicio;
                
                const guestInfoSmall = editingItemCard.querySelector('.form-group small.text-muted');
                if(guestInfoSmall) guestInfoSmall.innerHTML = `Este servicio se calculará para <strong>${numeroInvitadosParaEsteServicio}</strong> invitados.`;

                const componentesContainer = editingItemCard.querySelector('.componentes-seleccionados-display-container');
                const componentesLista = componentesContainer.querySelector('.componentes-display-lista');
                
                if (detalleHtmlComponentes) {
                    if(componentesLista) componentesLista.innerHTML = detalleHtmlComponentes;
                } else {
                    if(componentesLista) componentesLista.innerHTML = '<p class="componentes-display-none"><em>Servicio base o sin componentes detallados.</em></p>';
                }
                
                editingItemCard.querySelectorAll(`input[name^="items[${idx}][componentes]"]`).forEach(inp => inp.remove());
                let newHiddenInputsHTML = componentesSeleccionadosParaItem.map((comp, compIdx) => `
                    <input type="hidden" name="items[${idx}][componentes][${compIdx}][id_opcion_componente]" value="${comp.id_opcion_componente}">
                    <input type="hidden" name="items[${idx}][componentes][${compIdx}][cantidad_opcion_solicitada_cliente]" value="${comp.cantidad_opcion_solicitada_cliente}">
                `).join('');
                componentesContainer.insertAdjacentHTML('beforeend', newHiddenInputsHTML);
            } else {
                const nuevoItemIdx = itemCotizacionIndex;
                const itemHtml = `
                    <div class="item-cotizacion-card" data-item-idx="${nuevoItemIdx}">
                        <input type="hidden" name="items[${nuevoItemIdx}][id_item_cotizacion]" value="">
                        <input type="hidden" name="items[${nuevoItemIdx}][id_variante_servicio_config]" value="${idVarianteParaUsar}">
                        <input type="hidden" name="items[${nuevoItemIdx}][numero_invitados_servicio_item]" value="${numeroInvitadosParaEsteServicio}">
                        <div class="item-cotizacion-header">
                            <h5 class="item-nombre-display">
                                <input type="text" name="items[${nuevoItemIdx}][nombre_display_servicio]"
                                       value="${nombreVarianteParaUsar}" class="input-inline-editable" required>
                            </h5>
                            <div>
                                <button type="button" class="button button-edit-black-small edit-item-cotizacion-btn" style="margin-right: 5px;">Editar</button>
                                <button type="button" class="button button-danger-small remove-item-cotizacion-btn">Eliminar</button>
                            </div>
                        </div>
                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label>Cantidad del Servicio:</label>
                                <input type="number" name="items[${nuevoItemIdx}][cantidad_servicio]" value="1.0" min="0.1" step="any" class="input-cantidad-servicio">
                            </div>
                            <div class="form-group">
                                <label>Precio Total Ítem (Estimado):</label>
                                 <input type="number" step="0.01" name="items[${nuevoItemIdx}][precio_total_item_calculado]"
                                       value="${parseFloat(precioEstimadoOriginal).toFixed(2)}" class="input-precio-item" readonly style="font-weight:bold; background-color:#e9ecef;">
                            </div>
                        </div>
                        <div class="form-group">
                            <small class="text-muted">Este servicio se calculará para <strong>${numeroInvitadosParaEsteServicio}</strong> invitados.</small>
                        </div>
                        <div class="form-group">
                            <label>Descripción (para el cliente):</label>
                            <textarea name="items[${nuevoItemIdx}][descripcion_servicio_cotizado]" rows="2" class="input-descripcion-servicio">${currentConfiguredVariant ? (currentConfiguredVariant.descripcion_publica || '') : ''}</textarea>
                        </div>
                        <div class="componentes-seleccionados-display-container">
                            <strong class="componentes-display-titulo">Componentes Seleccionados (Estimación para ${numeroInvitadosParaEsteServicio} inv.):</strong>
                            ${detalleHtmlComponentes ? `<ul class="componentes-display-lista">${detalleHtmlComponentes}</ul>` : '<p class="componentes-display-none"><em>Servicio base o sin componentes detallados.</em></p>'}
                            ${componentesSeleccionadosParaItem.map((comp, compIdx) => `
                                <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][id_opcion_componente]" value="${comp.id_opcion_componente}">
                                <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][cantidad_opcion_solicitada_cliente]" value="${comp.cantidad_opcion_solicitada_cliente}">
                            `).join('')}
                        </div>
                    </div>
                `;
                itemsCotizacionContainer.insertAdjacentHTML('beforeend', itemHtml);
                itemCotizacionIndex++; 
            }
            
            resetServiceConfigurator(true); 
            if(noItemsMessage) noItemsMessage.style.display = 'none';
            calcularTotalesGenerales();
        });
    }

    if (itemsCotizacionContainer) {
        itemsCotizacionContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-item-cotizacion-btn')) {
                event.target.closest('.item-cotizacion-card').remove();
                let currentIdx = 0;
                itemsCotizacionContainer.querySelectorAll('.item-cotizacion-card').forEach(card => {
                    card.dataset.itemIdx = currentIdx;
                    card.querySelectorAll('[name^="items["]').forEach(input => {
                        const oldName = input.name;
                        const newName = oldName.replace(/items\[\d+\]/, `items[${currentIdx}]`);
                        input.name = newName;
                    });
                    currentIdx++;
                });
                itemCotizacionIndex = currentIdx; 

                if (itemsCotizacionContainer.children.length === 0 && noItemsMessage) {
                    noItemsMessage.style.display = 'block';
                }
                calcularTotalesGenerales();
            } else if (event.target.classList.contains('edit-item-cotizacion-btn')) {
                const cardToEdit = event.target.closest('.item-cotizacion-card');
                handleEditItemClick(cardToEdit);
            }
        });
    }

    const formCotizacion = document.getElementById('formConfigurarCotizacion');
    function calcularTotalesGenerales() {
        let subtotalServicios = 0;
        formCotizacion.querySelectorAll('.item-cotizacion-card').forEach(card => {
            const cantidadInput = card.querySelector('.input-cantidad-servicio');
            const precioInput = card.querySelector('.input-precio-item');
            const cantidad = parseFloat(cantidadInput.value) || 1.0; 
            subtotalServicios += (parseFloat(precioInput.value) || 0) * cantidad;
        });

        document.getElementById('displaySubtotalServicios').textContent = '$' + subtotalServicios.toFixed(2);

        const costosLogisticos = parseFloat(document.getElementById('monto_costos_logisticos').value) || 0;
        const subtotalGeneral = subtotalServicios + costosLogisticos;
        document.getElementById('displaySubtotalGeneral').textContent = '$' + subtotalGeneral.toFixed(2);

        // Cálculo con porcentajes
        const porcentajeDescuento = parseFloat(inputPorcentajeDescuento.value) || 0;
        const montoDescuento = (subtotalGeneral * (porcentajeDescuento / 100));
        if(inputMontoDescuentoCalculado) inputMontoDescuentoCalculado.value = montoDescuento.toFixed(2);
        document.getElementById('displayDescuentoGlobal').textContent = '-$' + montoDescuento.toFixed(2);

        const baseParaImpuestos = subtotalGeneral - montoDescuento;
        const porcentajeImpuestos = parseFloat(inputPorcentajeImpuestos.value) || 0;
        const montoImpuestos = (baseParaImpuestos * (porcentajeImpuestos / 100));
        if(inputMontoImpuestosCalculado) inputMontoImpuestosCalculado.value = montoImpuestos.toFixed(2);
        document.getElementById('displayImpuestos').textContent = '+$' + montoImpuestos.toFixed(2);

        const totalCotizado = baseParaImpuestos + montoImpuestos;
        document.getElementById('displayTotalCotizado').textContent = '$' + totalCotizado.toFixed(2);
    }


    if (formCotizacion) {
        formCotizacion.addEventListener('input', function(event) {
            const target = event.target;
            if (target.classList.contains('input-precio-item') ||
                target.classList.contains('input-cantidad-servicio') || 
                target.id === 'monto_costos_logisticos' ||
                target.id === 'porcentaje_descuento_global' || // Cambiado a porcentaje
                target.id === 'porcentaje_impuestos' ||      // Cambiado a porcentaje
                target.id === 'numero_invitados_cotizacion' || 
                target.id === 'config_numero_invitados_este_servicio' 
                ) {
                if (target.id === 'numero_invitados_cotizacion' && displayInvitadosGeneralesEventoEl) {
                     const numInvCot = target.value.trim() || '1';
                     displayInvitadosGeneralesEventoEl.textContent = numInvCot;
                     if (chkUsarInvitadosGeneralesEventoEl && chkUsarInvitadosGeneralesEventoEl.checked && inputNumeroInvitadosEsteServicioEl) {
                         inputNumeroInvitadosEsteServicioEl.value = numInvCot;
                     }
                }
                calcularTotalesGenerales();
            }
        });
        if (itemCotizacionIndex > 0) { // Calcular al cargar si ya hay ítems
            calcularTotalesGenerales();
        }
    }
});
</script>
{% endblock %}
