{% extends "base.html" %}

{% block content %}
<form method="POST" action="{{ url_for('cotizaciones_bp.vista_crear_evento_cotizacion_integral') }}" class="styled-form" id="formCrearEventoCotizacionIntegral">
    
    {# --- Sección 1: Información General del Evento (Proyecto) --- #}
    <fieldset class="form-section">
        <legend><h4>Paso 1: Datos del Evento (Proyecto)</h4></legend>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="identificador_evento">Identificador Único del Evento: <span class="required-indicator">*</span></label>
                <input type="text" name="identificador_evento" id="identificador_evento"
                       value="{{ form_data.get('identificador_evento', '') }}" required>
                <small class="form-text text-muted">Ej: "graduacion_ana_2025". Sin espacios.</small>
            </div>
            <div class="form-group">
                <label for="nombre_evento">Nombre del Evento: <span class="required-indicator">*</span></label>
                <input type="text" name="nombre_evento" id="nombre_evento"
                       value="{{ form_data.get('nombre_evento', '') }}" required>
            </div>
        </div>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="fecha_evento">Fecha del Evento: <span class="required-indicator">*</span></label>
                <input type="date" name="fecha_evento" id="fecha_evento"
                       value="{{ form_data.get('fecha_evento', fecha_hoy) }}" required>
            </div>
            <div class="form-group">
                <label for="numero_invitados_proyecto">Número de Invitados (General del Evento): <span class="required-indicator">*</span></label>
                <input type="number" name="numero_invitados_proyecto" id="numero_invitados_proyecto"
                       value="{{ form_data.get('numero_invitados_proyecto', '1') }}" min="1" required>
                <small>Este será el número de invitados por defecto para los servicios.</small>
            </div>
        </div>
        <h5 class="form-section-subtitle">Información del Cliente</h5>
        <div class="form-group">
            <label for="cliente_nombre">Nombre del Cliente:</label>
            <input type="text" name="cliente_nombre" id="cliente_nombre"
                   value="{{ form_data.get('cliente_nombre', '') }}">
        </div>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="cliente_telefono">Teléfono del Cliente:</label>
                <input type="tel" name="cliente_telefono" id="cliente_telefono"
                       value="{{ form_data.get('cliente_telefono', '') }}">
            </div>
            <div class="form-group">
                <label for="cliente_email">Email del Cliente:</label>
                <input type="email" name="cliente_email" id="cliente_email"
                       value="{{ form_data.get('cliente_email', '') }}">
            </div>
        </div>
        <h5 class="form-section-subtitle">Detalles de Ubicación (Proyecto)</h5>
        <div class="form-group">
            <label for="direccion_evento">Dirección del Evento:</label>
            <input type="text" name="direccion_evento" id="direccion_evento" value="{{ form_data.get('direccion_evento', '') }}">
        </div>
        <div class="form-group">
            <label for="tipo_ubicacion">Tipo de Ubicación:</label>
            <select name="tipo_ubicacion" id="tipo_ubicacion">
                <option value="Local (CDMX y Área Metropolitana)" {% if form_data.get('tipo_ubicacion') == 'Local (CDMX y Área Metropolitana)' or not form_data.get('tipo_ubicacion') %}selected{% endif %}>Local (CDMX y Área Metropolitana)</option>
                <option value="Foráneo (Interior de la República)" {% if form_data.get('tipo_ubicacion') == 'Foráneo (Interior de la República)' %}selected{% endif %}>Foráneo (Interior de la República)</option>
                <option value="Foráneo (Internacional)" {% if form_data.get('tipo_ubicacion') == 'Foráneo (Internacional)' %}selected{% endif %}>Foráneo (Internacional)</option>
                <option value="Otro" {% if form_data.get('tipo_ubicacion') == 'Otro' %}selected{% endif %}>Otro</option>
            </select>
        </div>
        <div class="form-group">
            <label for="notas_proyecto">Notas Adicionales del Proyecto:</label>
            <textarea name="notas_proyecto" id="notas_proyecto" rows="2">{{ form_data.get('notas_proyecto', '') }}</textarea>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Paso 2: Datos Generales de la Cotización (V1)</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="fecha_emision_cotizacion">Fecha de Emisión: <span class="required-indicator">*</span></label>
                <input type="date" name="fecha_emision_cotizacion" id="fecha_emision_cotizacion"
                       value="{{ form_data.get('fecha_emision_cotizacion', fecha_hoy) }}" required>
            </div>
            <div class="form-group">
                <label for="fecha_validez_cotizacion">Válida Hasta (Opcional):</label>
                <input type="date" name="fecha_validez_cotizacion" id="fecha_validez_cotizacion"
                       value="{{ form_data.get('fecha_validez_cotizacion', '') }}">
            </div>
            <div class="form-group">
                <label for="estado_cotizacion">Estado de la Cotización:</label>
                <select name="estado_cotizacion" id="estado_cotizacion">
                    <option value="Borrador" {% if form_data.get('estado_cotizacion') == 'Borrador' or not form_data.get('estado_cotizacion') %}selected{% endif %}>Borrador</option>
                    <option value="Presentada" {% if form_data.get('estado_cotizacion') == 'Presentada' %}selected{% endif %}>Presentada</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4 id="configuradorServicioTitulo_integral">Paso 3: Añadir Servicios a la Cotización</h4></legend>
        <input type="hidden" id="editing_item_idx_integral" value="">
        <input type="hidden" id="editing_item_id_variante_config_original_integral" value="">

        <p class="subtle-text">Selecciona un tipo de servicio, paquete y perfil. Luego, define los invitados para este servicio y configura sus componentes antes de añadirlo.</p>

        <div class="form-grid-3col" style="margin-bottom: 20px;">
            <div class="form-group">
                <label for="select_tipo_servicio_base_integral">1. Tipo de Servicio:</label>
                <select id="select_tipo_servicio_base_integral" class="form-control">
                    <option value="">-- Selecciona Tipo --</option>
                    {% for tsb in todos_tipos_servicio_base_activos %}
                        <option value="{{ tsb.id_tipo_servicio_base }}">{{ tsb.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="select_nivel_paquete_integral">2. Nivel de Paquete:</label>
                <select id="select_nivel_paquete_integral" class="form-control" disabled>
                    <option value="">-- Selecciona Paquete --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="select_nivel_perfil_integral">3. Nivel de Perfil:</label>
                <select id="select_nivel_perfil_integral" class="form-control" disabled>
                    <option value="">-- Selecciona Perfil --</option>
                </select>
            </div>
        </div>

        <div id="info_variante_seleccionada_integral" class="selected-product-info-box-compact" style="display:none; margin-bottom:15px; background-color: #e6fff3; border-color: #b3ffda;">
            Variante Seleccionada: <strong id="nombre_variante_display_integral"></strong> (ID: <span id="id_variante_display_integral"></span>)
        </div>

        <div id="config_invitados_para_servicio_actual_container_integral" style="display:none; margin-top: 15px; margin-bottom:15px; padding:15px; border: 1px solid #e0e4e8; border-radius: var(--radio-borde-general); background-color: #f9fafb;">
            <h6 style="margin-top:0; margin-bottom:10px; font-weight:500;">Invitados para este Servicio Específico:</h6>
            <div class="form-group">
                <label for="config_usar_invitados_generales_evento_integral" class="checkbox-label-inline">
                    <input type="checkbox" id="config_usar_invitados_generales_evento_integral" checked>
                    Aplicar invitados generales del evento (<span id="config_display_invitados_generales_evento_integral">N/A</span>)
                </label>
            </div>
            <div class="form-group" id="config_campo_invitados_especificos_servicio_integral" style="display:none; margin-top: 8px;">
                <label for="config_numero_invitados_este_servicio_integral">Número de invitados para ESTE servicio:</label>
                <input type="number" id="config_numero_invitados_este_servicio_integral" min="1" class="form-control" style="width: 100px;">
            </div>
        </div>

        <div id="contenedor_grupos_columnas_integral" class="opciones-servicio-container-columnas" style="display:none;">
            {# Aquí se cargarán dinámicamente los grupos y opciones #}
        </div>
        
        <div id="acciones_servicio_configurable_integral" style="margin-top: 20px; display:none;">
             <button type="button" id="btnAnadirServicioConfiguradoComoItem_integral" class="button button-primary">
                Añadir este Servicio Configurado a la Cotización
            </button>
             <button type="button" id="btnCancelarEdicionServicio_integral" class="button button-secondary" style="display:none; margin-left:10px;">
                Cancelar Edición
            </button>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Ítems de la Cotización</h4></legend>
        <div id="items-cotizacion-container-integral">
            {# Los ítems se añadirán aquí con JavaScript #}
        </div>
        <p id="noItemsCotizacionMessage_integral" style="text-align:center; padding:10px;">
            Aún no has añadido ítems a esta cotización.
        </p>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Costos Logísticos y Totales de la Cotización</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="costo_transporte_cotizacion">Costo Transporte ($):</label>
                <input type="number" step="0.01" name="costo_transporte_cotizacion" id="costo_transporte_cotizacion"
                       value="{{ form_data.get('costo_transporte_cotizacion', '0.00') }}" min="0">
            </div>
            <div class="form-group">
                <label for="costo_viaticos_cotizacion">Costo Viáticos ($):</label>
                <input type="number" step="0.01" name="costo_viaticos_cotizacion" id="costo_viaticos_cotizacion"
                       value="{{ form_data.get('costo_viaticos_cotizacion', '0.00') }}" min="0">
            </div>
            <div class="form-group">
                <label for="costo_hospedaje_cotizacion">Costo Hospedaje ($):</label>
                <input type="number" step="0.01" name="costo_hospedaje_cotizacion" id="costo_hospedaje_cotizacion"
                       value="{{ form_data.get('costo_hospedaje_cotizacion', '0.00') }}" min="0">
            </div>
        </div>
        <input type="hidden" name="monto_costos_logisticos_cotizacion" id="monto_costos_logisticos_cotizacion_hidden" value="{{ (form_data.get('costo_transporte_cotizacion', '0.00')|float(0) + form_data.get('costo_viaticos_cotizacion', '0.00')|float(0) + form_data.get('costo_hospedaje_cotizacion', '0.00')|float(0))|round(2) }}">

        <div class="form-grid-2col" style="margin-top:15px;">
            <div class="form-group">
                <label for="porcentaje_descuento_global_cotizacion">Descuento Global (%):</label>
                <input type="number" step="0.01" name="porcentaje_descuento_global_cotizacion" id="porcentaje_descuento_global_cotizacion"
                       value="{{ form_data.get('porcentaje_descuento_global_cotizacion', '0.00') }}" min="0" max="100">
                <input type="hidden" name="monto_descuento_global_calculado_cotizacion" id="monto_descuento_global_calculado_cotizacion" value="{{ form_data.get('monto_descuento_global_calculado_cotizacion', '0.00') }}">
            </div>
            <div class="form-group">
                <label for="porcentaje_impuestos_cotizacion">Impuestos (ej. IVA %):</label>
                <input type="number" step="0.01" name="porcentaje_impuestos_cotizacion" id="porcentaje_impuestos_cotizacion"
                       value="{{ form_data.get('porcentaje_impuestos_cotizacion', '16.00') }}" min="0">
                <input type="hidden" name="monto_impuestos_calculado_cotizacion" id="monto_impuestos_calculado_cotizacion" value="{{ form_data.get('monto_impuestos_calculado_cotizacion', '0.00') }}">
            </div>
        </div>
        <hr style="margin: 20px 0;">
        <div class="resumen-totales" style="text-align: right; font-size: 1.1em;">
            <p>Subtotal Servicios/Productos: <strong id="displaySubtotalServicios_integral">$0.00</strong></p>
            <p>Costos Logísticos: <strong id="displayCostosLogisticos_integral">+$0.00</strong></p>
            <p>Subtotal General: <strong id="displaySubtotalGeneral_integral">$0.00</strong></p>
            <p style="color: var(--color-peligro);">Menos Descuento Global: <strong id="displayDescuentoGlobal_integral">-$0.00</strong></p>
            <p>Más Impuestos: <strong id="displayImpuestos_integral">+$0.00</strong></p>
            <h4 style="margin-top:10px; font-size: 1.3em;">TOTAL COTIZADO: <strong id="displayTotalCotizado_integral" style="color: var(--color-acento-secundario);">$0.00</strong></h4>
        </div>
    </fieldset>

     <fieldset class="form-section">
        <legend><h4>Términos, Condiciones y Notas Adicionales (Cotización)</h4></legend>
        <div class="form-group">
            <label for="terminos_condiciones_cotizacion">Términos y Condiciones:</label>
            <textarea name="terminos_condiciones_cotizacion" id="terminos_condiciones_cotizacion" rows="4">{{ form_data.get('terminos_condiciones_cotizacion', '') }}</textarea>
        </div>
        <div class="form-group">
            <label for="notas_cotizacion_internas">Notas Internas de la Cotización (no visibles al cliente):</label>
            <textarea name="notas_cotizacion_internas" id="notas_cotizacion_internas" rows="2">{{ form_data.get('notas_cotizacion_internas', '') }}</textarea>
        </div>
    </fieldset>

    <div class="form-actions">
        <a href="{{ url_for('proyectos_bp.vista_listar_proyectos') }}" class="button button-secondary">Cancelar Todo</a>
        <button type="submit" name="accion" value="guardar_finalizar" class="button button-primary">
            Crear Evento y Finalizar Cotización
        </button>
    </div>
</form>

<style>
    /* Estilos generales del formulario ya definidos en style.css o base.html */
    .form-section-subtitle { 
        font-size: 0.95em; font-weight: 600; color: var(--color-texto-principal);
        margin-top: 20px; margin-bottom: 12px; padding-bottom: 5px;
        border-bottom: 1px solid var(--color-borde-sutil);
    }
    .subtle-text { font-size: 0.9em; color: var(--color-texto-secundario); line-height: 1.5; }
    .required-indicator { color: var(--color-peligro); font-weight: bold; margin-left: 2px; }
    
    .opciones-servicio-container-columnas {
        display: flex; 
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0; 
        border-radius: var(--radio-borde-general);
        margin-top: 15px; 
        background-color: #ffffff; 
    }
    .grupo-columna { 
        flex-basis: 280px; 
        flex-grow: 1; 
        padding: 15px;
        border: 1px solid #d1d5db; 
        border-radius: var(--radio-borde-general);
        background-color: #ffffff; 
        box-shadow: var(--sombra-caja-ligera);
    }
    .grupo-columna h6 {
        font-size: 1.05em; font-weight: 600; color: var(--color-texto-principal);
        margin-top: 0; margin-bottom: 12px; padding-bottom: 8px;
        border-bottom: 1px solid var(--color-borde-sutil);
    }
    .grupo-columna .opcion-checkbox-item { display: block; margin-bottom: 10px; }
    .grupo-columna .opcion-checkbox-item label {
        font-size: 0.9em; color: var(--color-texto-secundario);
        display: flex; align-items: center; cursor: pointer;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"] {
        margin-right: 8px; height: 16px; width: 16px;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"]:disabled + span {
        color: #b0b0b0; text-decoration: line-through;
    }
     .grupo-columna .opcion-checkbox-item label:has(input[type="checkbox"]:disabled) {
        cursor: not-allowed; opacity: 0.6;
    }

    .selected-product-info-box-compact {
        margin-top: 5px; padding: 8px 12px; background-color: #eef3f7;
        border: 1px solid #d1dce5; border-radius: var(--radio-borde-general);
        font-size: 0.85em; color: var(--color-texto-secundario);
    }
    .selected-product-info-box-compact strong { color: var(--color-texto-principal); font-weight: 500;}
    
    .item-cotizacion-card {
        background-color: #fff; border: 1px solid #e0e0e0;
        border-radius: var(--radio-borde-general); padding: 15px;
        margin-bottom: 15px; box-shadow: var(--sombra-caja-ligera);
    }
    .item-cotizacion-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;
    }
    .item-cotizacion-header .item-nombre-display {
        margin: 0; flex-grow: 1; font-size: 1.1em;
        font-weight: 600; color: var(--color-texto-principal);
    }
    .input-inline-editable {
        border: none; background-color: transparent; padding: 2px 5px;
        font-size: inherit; font-weight: inherit; color: inherit;
        width: calc(100% - 10px); box-shadow: none;
    }
    .input-inline-editable:focus {
        background-color: #f0f8ff; border: 1px solid var(--color-borde-input);
    }
    .button.button-danger-small.remove-item-cotizacion-btn {
        background-color: var(--color-peligro); color: white;
        border: 1px solid var(--color-peligro); padding: 6px 12px;
        font-size: 0.85em;
    }
    .button-edit-black-small { /* Estilo para el botón de editar más pequeño */
        background-color: var(--color-texto-principal);
        color: white;
        padding: 4px 8px;
        font-size: 0.8em;
        border-radius: var(--radio-borde-general);
        text-decoration: none;
        border: 1px solid var(--color-texto-principal);
        transition: background-color 0.2s ease, opacity 0.2s ease;
    }
    .button-edit-black-small:hover {
        background-color: #333;
        opacity: 0.9;
    }
     .componentes-seleccionados-display-container {
        margin-top: 15px; padding: 12px 15px; background-color: #f8f9fa;
        border: 1px solid #e9ecef; border-radius: var(--radio-borde-general); font-size: 0.9em;
    }
    .componentes-display-titulo {
        display: block; font-weight: 600; color: var(--color-texto-principal);
        margin-bottom: 8px; font-size: 0.95em;
    }
    .componentes-display-lista { list-style-type: none; padding-left: 0; margin-bottom: 0; }
    .componentes-display-item {
        padding: 5px 0; color: var(--color-texto-secundario);
        border-bottom: 1px dotted #e0e0e0; display: flex;
        justify-content: space-between; align-items: center;
    }
    .componentes-display-item:last-child { border-bottom: none; }
    .componente-cantidad-display {
        font-size: 0.9em; color: #555; background-color: #e9ecef;
        padding: 2px 6px; border-radius: 4px;
    }
    .componentes-display-none { color: #777; font-style: italic; padding: 5px 0; }
    
    .checkbox-label-inline { 
        display: flex;
        align-items: center;
        font-weight: normal !important;
        font-size: 0.9em !important;
    }
    .checkbox-label-inline input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(0.9); 
    }
    
    #config_invitados_para_servicio_actual_container_integral {
        /* Estilos de layout ya definidos inline */
    }
    #config_invitados_para_servicio_actual_container_integral h6 {
        font-size: 1em;
    }
    #config_invitados_para_servicio_actual_container_integral .form-group {
        margin-bottom: 8px; 
    }
    #config_invitados_para_servicio_actual_container_integral .form-group:last-child {
        margin-bottom: 0;
    }
</style>

<script id="todas_variantes_config_json_integral" type="application/json">
    {{ todas_variantes_config | tojson | safe }}
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // IDs específicos para esta plantilla (con _integral)
    const selectTipoServicio = document.getElementById('select_tipo_servicio_base_integral');
    const selectNivelPaquete = document.getElementById('select_nivel_paquete_integral');
    const selectNivelPerfil = document.getElementById('select_nivel_perfil_integral');
    const infoVarianteDiv = document.getElementById('info_variante_seleccionada_integral');
    const nombreVarianteDisplay = document.getElementById('nombre_variante_display_integral');
    const idVarianteDisplay = document.getElementById('id_variante_display_integral');
    
    const configInvitadosServicioContainerEl = document.getElementById('config_invitados_para_servicio_actual_container_integral');
    const chkUsarInvitadosGeneralesEventoEl = document.getElementById('config_usar_invitados_generales_evento_integral');
    const displayInvitadosGeneralesEventoEl = document.getElementById('config_display_invitados_generales_evento_integral');
    const campoInvitadosEspecificosServicioEl = document.getElementById('config_campo_invitados_especificos_servicio_integral');
    const inputNumeroInvitadosEsteServicioEl = document.getElementById('config_numero_invitados_este_servicio_integral');
    
    // Referencia al input de invitados generales del PROYECTO para esta plantilla
    const inputNumeroInvitadosProyectoEl = document.getElementById('numero_invitados_proyecto'); 
    
    const contenedorGruposColumnas = document.getElementById('contenedor_grupos_columnas_integral');
    const accionesServicioConfigurableDiv = document.getElementById('acciones_servicio_configurable_integral');
    const btnAnadirServicioConfigurado = document.getElementById('btnAnadirServicioConfiguradoComoItem_integral');
    const itemsCotizacionContainer = document.getElementById('items-cotizacion-container-integral');
    const noItemsMessage = document.getElementById('noItemsCotizacionMessage_integral');
    
    let itemCotizacionIndex = document.querySelectorAll('#items-cotizacion-container-integral .item-cotizacion-card').length;
    let currentConfiguredVariant = null;
    let currentConfiguredVariantEstructura = null;

    let isEditingItemMode = false;
    let editingItemCard = null; 
    let componentesParaEditar = [];
    const configuradorServicioTitulo = document.getElementById('configuradorServicioTitulo_integral');
    const btnCancelarEdicionServicio = document.getElementById('btnCancelarEdicionServicio_integral');
    const editingItemIdxInput = document.getElementById('editing_item_idx_integral');
    const editingItemIdVarianteOriginalInput = document.getElementById('editing_item_id_variante_config_original_integral');

    // Cargar datos de variantes desde el JSON incrustado
    let todasVariantesJS = [];
    const variantesJsonScript = document.getElementById('todas_variantes_config_json_integral');
    if (variantesJsonScript) {
        try {
            todasVariantesJS = JSON.parse(variantesJsonScript.textContent);
        } catch (e) {
            console.error("Error parseando JSON de variantes:", e);
        }
    }

    // Nuevos elementos para descuento e impuestos porcentuales
    const porcentajeDescuentoGlobalInputEl = document.getElementById('porcentaje_descuento_global_cotizacion');
    const montoDescuentoGlobalCalculadoHiddenEl = document.getElementById('monto_descuento_global_calculado_cotizacion');
    const porcentajeImpuestosInputEl = document.getElementById('porcentaje_impuestos_cotizacion');
    const montoImpuestosCalculadoHiddenEl = document.getElementById('monto_impuestos_calculado_cotizacion');


    function populateSelect(selectElement, options, placeholder) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        if (options && Array.isArray(options)) { 
            options.forEach(option => {
                const value = typeof option === 'object' ? option.id : option;
                const text = typeof option === 'object' ? option.nombre : option;
                selectElement.add(new Option(text, value));
            });
        }
        selectElement.disabled = !(options && options.length > 0);
    }

    function resetServiceConfiguratorIntegral(clearMainSelects = true) {
        if(clearMainSelects){
            if(selectTipoServicio) { selectTipoServicio.value = ""; selectTipoServicio.disabled = false; }
            if(selectNivelPaquete) { populateSelect(selectNivelPaquete, [], '-- Selecciona Paquete --'); selectNivelPaquete.disabled = true;}
            if(selectNivelPerfil) { populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --'); selectNivelPerfil.disabled = true;}
        }
        if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
        if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
        if(contenedorGruposColumnas) {
            contenedorGruposColumnas.style.display = 'none';
            contenedorGruposColumnas.innerHTML = '';
        }
        if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
        
        currentConfiguredVariant = null;
        currentConfiguredVariantEstructura = null;
        
        isEditingItemMode = false;
        editingItemCard = null;
        componentesParaEditar = [];
        if(configuradorServicioTitulo) configuradorServicioTitulo.textContent = "Paso 3: Añadir Servicios a la Cotización";
        if(btnAnadirServicioConfigurado) btnAnadirServicioConfigurado.textContent = "Añadir este Servicio Configurado a la Cotización";
        if(btnCancelarEdicionServicio) btnCancelarEdicionServicio.style.display = 'none';
        if(editingItemIdxInput) editingItemIdxInput.value = "";
        if(editingItemIdVarianteOriginalInput) editingItemIdVarianteOriginalInput.value = "";
    }

    if(btnCancelarEdicionServicio){
        btnCancelarEdicionServicio.addEventListener('click', function(){
            resetServiceConfiguratorIntegral(true); 
        });
    }

    async function fetchAndPopulateIntegral(selectElement, url, placeholder, dependentActionCallback = null) {
        if (!selectElement) return;
        populateSelect(selectElement, [], placeholder); 
        selectElement.disabled = true;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error API: ${response.status}`);
            const data = await response.json();
            populateSelect(selectElement, data, placeholder);
            if (dependentActionCallback) await dependentActionCallback();
        } catch (error) {
            console.error(`Error fetching para ${selectElement.id}:`, error);
            populateSelect(selectElement, [], placeholder); 
        }
    }
    
    if (selectTipoServicio) {
        selectTipoServicio.addEventListener('change', async function() {
            const tipoBaseId = this.value;
            if (!isEditingItemMode) { 
                resetServiceConfiguratorIntegral(false); 
            }
            populateSelect(selectNivelPaquete, [], '-- Selecciona Paquete --');
            selectNivelPaquete.disabled = true;
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            selectNivelPerfil.disabled = true;

            if (tipoBaseId) {
                await fetchAndPopulateIntegral(
                    selectNivelPaquete,
                    `{{ url_for('admin_servicios_bp.api_get_niveles_paquete') }}?id_tipo_base=${tipoBaseId}`,
                    '-- Selecciona Paquete --',
                    async () => { 
                        if (isEditingItemMode && editingItemCard) {
                            const idVarianteActual = editingItemIdVarianteOriginalInput.value;
                            const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);
                            if (varianteObjActual && varianteObjActual.id_tipo_servicio_base == tipoBaseId && Array.from(selectNivelPaquete.options).map(o=>o.value).includes(String(varianteObjActual.nivel_paquete))) {
                                selectNivelPaquete.value = varianteObjActual.nivel_paquete;
                                selectNivelPaquete.disabled = true; 
                                await selectNivelPaquete.dispatchEvent(new Event('change'));
                            } else if (isEditingItemMode) { 
                                selectNivelPaquete.disabled = true;
                            }
                        }
                    }
                );
            }
        });
    }

    if (selectNivelPaquete) {
        selectNivelPaquete.addEventListener('change', async function() {
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = this.value;
            
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            selectNivelPerfil.disabled = true;
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
            if(contenedorGruposColumnas) { contenedorGruposColumnas.style.display = 'none'; contenedorGruposColumnas.innerHTML = '';}
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null; currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre) {
                 await fetchAndPopulateIntegral(
                    selectNivelPerfil,
                    `{{ url_for('admin_servicios_bp.api_get_niveles_perfil') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}`,
                    '-- Selecciona Perfil --',
                    async () => { 
                        if (isEditingItemMode && editingItemCard) {
                            const idVarianteActual = editingItemIdVarianteOriginalInput.value;
                            const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);
                            if (varianteObjActual && varianteObjActual.nivel_paquete == paqueteNombre && Array.from(selectNivelPerfil.options).map(o=>o.value).includes(String(varianteObjActual.nivel_perfil))) {
                                selectNivelPerfil.value = varianteObjActual.nivel_perfil;
                                selectNivelPerfil.disabled = true; 
                                await selectNivelPerfil.dispatchEvent(new Event('change'));
                            } else if (isEditingItemMode) {
                                selectNivelPerfil.disabled = true;
                            }
                        }
                    }
                );
            }
        });
    }

    if (selectNivelPerfil) {
        selectNivelPerfil.addEventListener('change', async function() {
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = selectNivelPaquete.value;
            const perfilNombre = this.value;
            
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainerEl) configInvitadosServicioContainerEl.style.display = 'none';
            if(contenedorGruposColumnas) { contenedorGruposColumnas.style.display = 'none'; contenedorGruposColumnas.innerHTML = '';}
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null; currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre && perfilNombre) {
                try {
                    const response = await fetch(`{{ url_for('admin_servicios_bp.api_buscar_variante_por_niveles') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}&perfil=${encodeURIComponent(perfilNombre)}`);
                    if (!response.ok) throw new Error('Variante no encontrada o error en API');
                    const varianteData = await response.json();

                    if (varianteData && varianteData.id_variante_config) {
                        currentConfiguredVariant = varianteData; 
                        if(nombreVarianteDisplay) nombreVarianteDisplay.textContent = varianteData.nombre_variante;
                        if(idVarianteDisplay) idVarianteDisplay.textContent = varianteData.id_variante_config;
                        if(infoVarianteDiv) infoVarianteDiv.style.display = 'block';
                        
                        if (configInvitadosServicioContainerEl) {
                            const numInvProyecto = inputNumeroInvitadosProyectoEl ? (inputNumeroInvitadosProyectoEl.value.trim() || '1') : '1';
                            if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvProyecto;
                            
                            if (isEditingItemMode && editingItemCard) { 
                                const numInvitadosItemActual = parseInt(editingItemCard.querySelector(`input[name$="[numero_invitados_servicio_item]"]`).value);
                                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvitadosItemActual;
                                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = (numInvitadosItemActual == parseInt(numInvProyecto));
                            } else { 
                                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvProyecto;
                                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = true;
                            }
                            if(chkUsarInvitadosGeneralesEventoEl && campoInvitadosEspecificosServicioEl) {
                                campoInvitadosEspecificosServicioEl.style.display = chkUsarInvitadosGeneralesEventoEl.checked ? 'none' : 'block';
                            }
                            configInvitadosServicioContainerEl.style.display = 'block';
                        }
                        await cargarEstructuraVarianteIntegral(varianteData.id_variante_config, isEditingItemMode ? componentesParaEditar : []);
                    } else {
                        if(infoVarianteDiv) {
                            infoVarianteDiv.innerHTML = '<p style="color:red;">No se encontró una variante de servicio para esta combinación.</p>';
                            infoVarianteDiv.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Error buscando variante:", error);
                    if(infoVarianteDiv) {
                        infoVarianteDiv.innerHTML = `<p style="color:red;">Error al buscar variante: ${error.message}</p>`;
                        infoVarianteDiv.style.display = 'block';
                    }
                }
            }
        });
    }

    if (chkUsarInvitadosGeneralesEventoEl && campoInvitadosEspecificosServicioEl && inputNumeroInvitadosEsteServicioEl && inputNumeroInvitadosProyectoEl) {
        chkUsarInvitadosGeneralesEventoEl.addEventListener('change', function() {
            const numInvProyecto = inputNumeroInvitadosProyectoEl.value.trim() || '1';
            if (this.checked) {
                campoInvitadosEspecificosServicioEl.style.display = 'none';
                inputNumeroInvitadosEsteServicioEl.value = numInvProyecto;
            } else {
                campoInvitadosEspecificosServicioEl.style.display = 'block';
                inputNumeroInvitadosEsteServicioEl.focus();
            }
        });
        inputNumeroInvitadosProyectoEl.addEventListener('input', function() {
            const numInvProy = this.value.trim() || '1';
            if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvProy;
            if (chkUsarInvitadosGeneralesEventoEl.checked && inputNumeroInvitadosEsteServicioEl) {
                inputNumeroInvitadosEsteServicioEl.value = numInvProy;
            }
        });
        const numInvProyectoInicial = inputNumeroInvitadosProyectoEl.value.trim() || '1';
        if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvProyectoInicial;
        if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvProyectoInicial;
    }

    async function cargarEstructuraVarianteIntegral(idVariante, componentesASeleccionar = []) {
        try {
            const response = await fetch(`{{ url_for('admin_servicios_bp.api_get_estructura_variante') }}?id_variante_config=${idVariante}`);
            if (!response.ok) throw new Error('Error al cargar estructura de la variante');
            currentConfiguredVariantEstructura = await response.json();

            renderizarGruposEnColumnasIntegral(currentConfiguredVariantEstructura.grupos);
            
            if (componentesASeleccionar.length > 0) {
                componentesASeleccionar.forEach(idOpcionComp => {
                    const checkbox = contenedorGruposColumnas.querySelector(`input[type="checkbox"][value="${idOpcionComp}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            aplicarLogicaCheckboxesDinamicosIntegral(); 

            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'block';
            if(contenedorGruposColumnas) contenedorGruposColumnas.style.display = 'flex';
        } catch (error) {
            console.error("Error cargando estructura variante:", error);
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.innerHTML = `<p style="color:red;">Error al cargar opciones: ${error.message}</p>`;
                contenedorGruposColumnas.style.display = 'block';
            }
             if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
        }
    }

    function renderizarGruposEnColumnasIntegral(grupos) {
        if(!contenedorGruposColumnas) return;
        contenedorGruposColumnas.innerHTML = '';
        if (!grupos || grupos.length === 0) {
            contenedorGruposColumnas.innerHTML = '<p>Esta variante no tiene grupos de componentes configurados.</p>';
            return;
        }

        grupos.forEach(grupo => {
            const divColumnaGrupo = document.createElement('div');
            divColumnaGrupo.classList.add('grupo-columna');
            divColumnaGrupo.dataset.idGrupo = grupo.id_grupo_config;
            divColumnaGrupo.dataset.opcionesPermitidas = grupo.opciones_permitidas_seleccionables;

            const h6 = document.createElement('h6');
            h6.textContent = `${grupo.nombre_grupo} (Elige ${grupo.opciones_permitidas_seleccionables})`;
            divColumnaGrupo.appendChild(h6);

            if (grupo.opciones_disponibles && grupo.opciones_disponibles.length > 0) {
                grupo.opciones_disponibles.forEach(opcion => {
                    const divOpcion = document.createElement('div');
                    divOpcion.classList.add('opcion-checkbox-item');
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `config_grupo_opcion_${grupo.id_grupo_config}`; // Nombre específico para esta plantilla
                    checkbox.value = opcion.id_opcion_componente;
                    checkbox.dataset.nombreOpcion = opcion.nombre_display_cliente;
                    checkbox.dataset.cantidadConsumoBase = opcion.cantidad_consumo_base;
                    checkbox.dataset.unidadConsumoBase = opcion.unidad_consumo_base;
                    checkbox.dataset.idProductoInterno = opcion.producto_info ? opcion.producto_info.id_producto_interno : '';
                    checkbox.dataset.unidadProductoBase = opcion.producto_info ? opcion.producto_info.unidad_medida_base : opcion.unidad_consumo_base;
                    checkbox.dataset.productoEsIndivisible = opcion.producto_info ? opcion.producto_info.es_indivisible : (opcion.unidad_consumo_base === 'pieza');

                    const span = document.createElement('span');
                    span.textContent = ` ${opcion.nombre_display_cliente} (${opcion.cantidad_consumo_base} ${opcion.unidad_consumo_base})`;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    divOpcion.appendChild(label);
                    divColumnaGrupo.appendChild(divOpcion);
                });
            } else {
                divColumnaGrupo.innerHTML += '<p class="text-xs text-gray-500">No hay opciones en este grupo.</p>';
            }
            contenedorGruposColumnas.appendChild(divColumnaGrupo);
        });
    }

    function aplicarLogicaCheckboxesDinamicosIntegral() {
        document.querySelectorAll('#contenedor_grupos_columnas_integral .grupo-columna').forEach(grupoDiv => {
            const checkboxesEnGrupo = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]'));
            const maxSeleccionables = parseInt(grupoDiv.dataset.opcionesPermitidas);
            checkboxesEnGrupo.forEach(checkbox => {
                checkbox.addEventListener('change', () => { 
                    const seleccionadosActual = checkboxesEnGrupo.filter(cb => cb.checked).length;
                    if (seleccionadosActual >= maxSeleccionables) {
                        checkboxesEnGrupo.forEach(cb => {
                            if (!cb.checked) {
                                cb.disabled = true;
                                cb.closest('label').classList.add('opacity-60', 'cursor-not-allowed');
                            }
                        });
                    } else {
                        checkboxesEnGrupo.forEach(cb => {
                            cb.disabled = false;
                            cb.closest('label').classList.remove('opacity-60', 'cursor-not-allowed');
                        });
                    }
                });
                checkbox.dispatchEvent(new Event('change')); 
            });
        });
    }
    
    async function handleEditItemClickIntegral(itemCardToEdit) {
        editingItemCard = itemCardToEdit;
        isEditingItemMode = true;
        if(configuradorServicioTitulo) configuradorServicioTitulo.textContent = "Editando Componentes/Invitados del Servicio";
        if(btnAnadirServicioConfigurado) btnAnadirServicioConfigurado.textContent = "Actualizar Componentes/Invitados";
        if(btnCancelarEdicionServicio) btnCancelarEdicionServicio.style.display = 'inline-block';
        if(editingItemIdxInput) editingItemIdxInput.value = itemCardToEdit.dataset.itemIdx;

        const idVarianteActual = editingItemCard.querySelector(`input[name$="[id_variante_servicio_config]"]`).value;
        if(editingItemIdVarianteOriginalInput) editingItemIdVarianteOriginalInput.value = idVarianteActual;

        const numInvitadosItemActual = parseInt(editingItemCard.querySelector(`input[name$="[numero_invitados_servicio_item]"]`).value);
        componentesParaEditar = Array.from(editingItemCard.querySelectorAll(`input[name^="items[${itemCardToEdit.dataset.itemIdx}][componentes]"][name$="[id_opcion_componente]"]`)).map(inp => inp.value);

        const varianteObjActual = todasVariantesJS.find(v => v.id_variante_config == idVarianteActual);

        if (varianteObjActual) {
            selectTipoServicio.value = varianteObjActual.id_tipo_servicio_base;
            selectTipoServicio.disabled = true;
            
            await fetchAndPopulateIntegral(selectNivelPaquete, `{{ url_for('admin_servicios_bp.api_get_niveles_paquete') }}?id_tipo_base=${varianteObjActual.id_tipo_servicio_base}`, '-- Selecciona Paquete --');
            selectNivelPaquete.value = varianteObjActual.nivel_paquete;
            selectNivelPaquete.disabled = true;

            await fetchAndPopulateIntegral(selectNivelPerfil, `{{ url_for('admin_servicios_bp.api_get_niveles_perfil') }}?id_tipo_base=${varianteObjActual.id_tipo_servicio_base}&paquete=${encodeURIComponent(varianteObjActual.nivel_paquete)}`, '-- Selecciona Perfil --');
            selectNivelPerfil.value = varianteObjActual.nivel_perfil;
            selectNivelPerfil.disabled = true;
            
            currentConfiguredVariant = varianteObjActual; 
            if(nombreVarianteDisplay) nombreVarianteDisplay.textContent = varianteObjActual.nombre_variante;
            if(idVarianteDisplay) idVarianteDisplay.textContent = varianteObjActual.id_variante_config;
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'block';

            if (configInvitadosServicioContainerEl) {
                const numInvProyecto = inputNumeroInvitadosProyectoEl ? (inputNumeroInvitadosProyectoEl.value.trim() || '1') : '1';
                if(displayInvitadosGeneralesEventoEl) displayInvitadosGeneralesEventoEl.textContent = numInvProyecto;
                if(inputNumeroInvitadosEsteServicioEl) inputNumeroInvitadosEsteServicioEl.value = numInvitadosItemActual;
                if(chkUsarInvitadosGeneralesEventoEl) chkUsarInvitadosGeneralesEventoEl.checked = (numInvitadosItemActual == parseInt(numInvProyecto));
                if(campoInvitadosEspecificosServicioEl) campoInvitadosEspecificosServicioEl.style.display = chkUsarInvitadosGeneralesEventoEl.checked ? 'none' : 'block';
                configInvitadosServicioContainerEl.style.display = 'block';
            }
            await cargarEstructuraVarianteIntegral(idVarianteActual, componentesParaEditar);
        } else {
            alert("No se pudo encontrar la configuración de la variante para este ítem. No se pueden bloquear los selectores.");
            resetServiceConfiguratorIntegral(true); 
        }
    }


    if (btnAnadirServicioConfigurado) {
        btnAnadirServicioConfigurado.addEventListener('click', function() {
            const idVarianteParaUsar = isEditingItemMode ? editingItemIdVarianteOriginalInput.value : (currentConfiguredVariant ? currentConfiguredVariant.id_variante_config : null);
            const nombreVarianteParaUsar = isEditingItemMode ? (editingItemCard.querySelector('.item-nombre-display input') ? editingItemCard.querySelector('.item-nombre-display input').value : "Servicio Editado") : (currentConfiguredVariant ? currentConfiguredVariant.nombre_variante : "Servicio Desconocido");
            const precioEstimadoOriginal = isEditingItemMode ? parseFloat(editingItemCard.querySelector('.input-precio-item-integral').value) : (currentConfiguredVariant ? (currentConfiguredVariant.precio_base_sugerido || 0.00) : 0.00);


            if (!idVarianteParaUsar || !currentConfiguredVariantEstructura) {
                 alert("Por favor, selecciona y configura un servicio completamente primero (Tipo, Paquete, Perfil) o asegúrate de que el servicio a editar esté cargado.");
                return;
            }

            let numeroInvitadosParaEsteServicio;
            if (chkUsarInvitadosGeneralesEventoEl && chkUsarInvitadosGeneralesEventoEl.checked) {
                const numInvProyectoVal = inputNumeroInvitadosProyectoEl ? (inputNumeroInvitadosProyectoEl.value.trim() || '1') : '1';
                numeroInvitadosParaEsteServicio = parseInt(numInvProyectoVal);
            } else if (inputNumeroInvitadosEsteServicioEl) {
                numeroInvitadosParaEsteServicio = parseInt(inputNumeroInvitadosEsteServicioEl.value) || 1;
            } else {
                numeroInvitadosParaEsteServicio = parseInt(inputNumeroInvitadosProyectoEl.value) || 1; // Fallback a invitados del proyecto
            }
            if (numeroInvitadosParaEsteServicio < 1) numeroInvitadosParaEsteServicio = 1;

            const componentesSeleccionadosParaItem = [];
            let detalleHtmlComponentes = '';
            const totalGruposDisponiblesEnVariante = currentConfiguredVariantEstructura.grupos.length;
            let numeroDeGruposConSeleccionesEnVariante = 0;

            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (grupoDiv && grupoDiv.querySelectorAll('input[type="checkbox"]:checked').length > 0) {
                    numeroDeGruposConSeleccionesEnVariante++;
                }
            });

            let factorAjusteGlobalDeGrupos = 1.0;
            if (numeroDeGruposConSeleccionesEnVariante > 0 && numeroDeGruposConSeleccionesEnVariante < totalGruposDisponiblesEnVariante) {
                factorAjusteGlobalDeGrupos = totalGruposDisponiblesEnVariante / numeroDeGruposConSeleccionesEnVariante;
            }

            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (!grupoDiv) return;
                const opcionesPermitidasEnGrupo = parseInt(grupoDiv.dataset.opcionesPermitidas);
                const checkboxesSeleccionados = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]:checked'));
                const numOpcionesRealmenteElegidasEnGrupo = checkboxesSeleccionados.length;
                if (numOpcionesRealmenteElegidasEnGrupo === 0) return;
                const factorAjusteIntraGrupo = opcionesPermitidasEnGrupo / numOpcionesRealmenteElegidasEnGrupo;

                checkboxesSeleccionados.forEach(chk => {
                    const opcionOriginal = grupo.opciones_disponibles.find(o => o.id_opcion_componente == chk.value);
                    if (!opcionOriginal) return;
                    let cantidadConsumoBase = parseFloat(opcionOriginal.cantidad_consumo_base);
                    let cantidadAjustadaPorPersonaBruta = cantidadConsumoBase * factorAjusteIntraGrupo * factorAjusteGlobalDeGrupos;
                    let cantidadAjustadaPersonaFinal;
                    let unidadFinal = opcionOriginal.producto_info ? opcionOriginal.producto_info.unidad_medida_base : opcionOriginal.unidad_consumo_base;
                    let esIndivisible = opcionOriginal.producto_info ? opcionOriginal.producto_info.es_indivisible : (unidadFinal === 'pieza');

                    if (esIndivisible) {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta);
                    } else {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta / 5) * 5;
                         if (cantidadAjustadaPersonaFinal < cantidadAjustadaPorPersonaBruta) {
                             cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta / 5.000001) * 5;
                        }
                    }
                    let cantidadTotalEventoFinal = cantidadAjustadaPersonaFinal * numeroInvitadosParaEsteServicio; 
                    let cantFinalDisplay = esIndivisible ? cantidadTotalEventoFinal.toFixed(0) : (cantidadTotalEventoFinal % 1 === 0 ? cantidadTotalEventoFinal.toFixed(0) : cantidadTotalEventoFinal.toFixed(1));

                    detalleHtmlComponentes += `<li class="componentes-display-item">${opcionOriginal.nombre_display_cliente} <span class="componente-cantidad-display">(Cant: ${cantFinalDisplay} ${unidadFinal})</span></li>`;
                    componentesSeleccionadosParaItem.push({
                        id_opcion_componente: opcionOriginal.id_opcion_componente,
                        cantidad_opcion_solicitada_cliente: "1", 
                    });
                });
            });

            if (componentesSeleccionadosParaItem.length === 0 && currentConfiguredVariantEstructura.grupos.length > 0) {
                alert("Debes seleccionar al menos una opción de algún grupo para añadir el servicio, si la variante tiene grupos configurados.");
                return;
            }
            
            if (isEditingItemMode && editingItemCard) {
                const idx = editingItemCard.dataset.itemIdx;
                editingItemCard.querySelector(`input[name="items[${idx}][id_variante_servicio_config]"]`).value = idVarianteParaUsar;
                editingItemCard.querySelector(`input[name="items[${idx}][numero_invitados_servicio_item]"]`).value = numeroInvitadosParaEsteServicio;
                // No cambiar nombre ni precio base al editar solo componentes/invitados
                // editingItemCard.querySelector(`input[name="items[${idx}][nombre_display_servicio]"]`).value = nombreVarianteParaUsar;
                // editingItemCard.querySelector(`input[name="items[${idx}][precio_total_item_calculado]"]`).value = parseFloat(precioEstimadoOriginal).toFixed(2);
                
                const guestInfoSmall = editingItemCard.querySelector('.form-group small.text-muted');
                if(guestInfoSmall) guestInfoSmall.innerHTML = `Este servicio se calculará para <strong>${numeroInvitadosParaEsteServicio}</strong> invitados.`;

                const componentesContainer = editingItemCard.querySelector('.componentes-seleccionados-display-container');
                const componentesLista = componentesContainer.querySelector('.componentes-display-lista');
                
                if (detalleHtmlComponentes) {
                    if(componentesLista) componentesLista.innerHTML = detalleHtmlComponentes;
                } else {
                    if(componentesLista) componentesLista.innerHTML = '<p class="componentes-display-none"><em>Servicio base o sin componentes detallados.</em></p>';
                }
                
                editingItemCard.querySelectorAll(`input[name^="items[${idx}][componentes]"]`).forEach(inp => inp.remove());
                let newHiddenInputsHTML = componentesSeleccionadosParaItem.map((comp, compIdx) => `
                    <input type="hidden" name="items[${idx}][componentes][${compIdx}][id_opcion_componente]" value="${comp.id_opcion_componente}">
                    <input type="hidden" name="items[${idx}][componentes][${compIdx}][cantidad_opcion_solicitada_cliente]" value="${comp.cantidad_opcion_solicitada_cliente}">
                `).join('');
                componentesContainer.insertAdjacentHTML('beforeend', newHiddenInputsHTML);
            } else {
                const nuevoItemIdx = itemCotizacionIndex;
                const itemHtml = `
                    <div class="item-cotizacion-card" data-item-idx="${nuevoItemIdx}">
                        <input type="hidden" name="items[${nuevoItemIdx}][id_variante_servicio_config]" value="${idVarianteParaUsar}">
                        <input type="hidden" name="items[${nuevoItemIdx}][numero_invitados_servicio_item]" value="${numeroInvitadosParaEsteServicio}">
                        <div class="item-cotizacion-header">
                            <h5 class="item-nombre-display">
                                <input type="text" name="items[${nuevoItemIdx}][nombre_display_servicio]"
                                       value="${nombreVarianteParaUsar}" class="input-inline-editable" required>
                            </h5>
                            <div>
                                <button type="button" class="button button-edit-black-small edit-item-cotizacion-btn" style="margin-right: 5px;">Editar</button>
                                <button type="button" class="button button-danger-small remove-item-cotizacion-btn">Eliminar</button>
                            </div>
                        </div>
                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label>Cantidad del Servicio:</label>
                                <input type="number" name="items[${nuevoItemIdx}][cantidad_servicio]" value="1.0" min="0.1" step="any" class="input-cantidad-servicio-integral">
                            </div>
                            <div class="form-group">
                                <label>Precio Total Ítem (Estimado):</label>
                                 <input type="number" step="0.01" name="items[${nuevoItemIdx}][precio_total_item_calculado]"
                                       value="${parseFloat(precioEstimadoOriginal).toFixed(2)}" class="input-precio-item-integral" readonly style="font-weight:bold; background-color:#e9ecef;">
                            </div>
                        </div>
                        <div class="form-group">
                            <small class="text-muted">Este servicio se calculará para <strong>${numeroInvitadosParaEsteServicio}</strong> invitados.</small>
                        </div>
                        <div class="form-group">
                            <label>Descripción (para el cliente):</label>
                            <textarea name="items[${nuevoItemIdx}][descripcion_servicio_cotizado]" rows="2" class="input-descripcion-servicio-integral">${currentConfiguredVariant ? (currentConfiguredVariant.descripcion_publica || '') : ''}</textarea>
                        </div>
                        <div class="componentes-seleccionados-display-container">
                            <strong class="componentes-display-titulo">Componentes Seleccionados (Estimación para ${numeroInvitadosParaEsteServicio} inv.):</strong>
                            ${detalleHtmlComponentes ? `<ul class="componentes-display-lista">${detalleHtmlComponentes}</ul>` : '<p class="componentes-display-none"><em>Servicio base o sin componentes detallados.</em></p>'}
                            ${componentesSeleccionadosParaItem.map((comp, compIdx) => `
                                <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][id_opcion_componente]" value="${comp.id_opcion_componente}">
                                <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][cantidad_opcion_solicitada_cliente]" value="${comp.cantidad_opcion_solicitada_cliente}">
                            `).join('')}
                        </div>
                    </div>
                `;
                itemsCotizacionContainer.insertAdjacentHTML('beforeend', itemHtml);
                itemCotizacionIndex++; 
            }
            
            resetServiceConfiguratorIntegral(true); 
            if(noItemsMessage) noItemsMessage.style.display = 'none';
            calcularTotalesGeneralesIntegral();
        });
    }

    if (itemsCotizacionContainer) {
        itemsCotizacionContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-item-cotizacion-btn')) {
                event.target.closest('.item-cotizacion-card').remove();
                let currentIdx = 0;
                itemsCotizacionContainer.querySelectorAll('.item-cotizacion-card').forEach(card => {
                    card.dataset.itemIdx = currentIdx;
                    card.querySelectorAll('[name^="items["]').forEach(input => {
                        const oldName = input.name;
                        const newName = oldName.replace(/items\[\d+\]/, `items[${currentIdx}]`);
                        input.name = newName;
                         if(input.id && input.id.match(/items_\d+_/)){ // Re-indexar IDs también
                            const oldId = input.id;
                            const newId = oldId.replace(/items_\d+_/, `items_${currentIdx}_`);
                            input.id = newId;
                            const label = document.querySelector(`label[for="${oldId}"]`);
                            if(label) label.setAttribute('for', newId);
                        }
                    });
                    currentIdx++;
                });
                itemCotizacionIndex = currentIdx; 

                if (itemsCotizacionContainer.children.length === 0 && noItemsMessage) {
                    noItemsMessage.style.display = 'block';
                }
                calcularTotalesGeneralesIntegral();
            } else if (event.target.classList.contains('edit-item-cotizacion-btn')) {
                const cardToEdit = event.target.closest('.item-cotizacion-card');
                handleEditItemClickIntegral(cardToEdit);
            }
        });
    }

    const formCotizacionIntegralEl = document.getElementById('formCrearEventoCotizacionIntegral');
    const costoTransporteInputEl = document.getElementById('costo_transporte_cotizacion');
    const costoViaticosInputEl = document.getElementById('costo_viaticos_cotizacion');
    const costoHospedajeInputEl = document.getElementById('costo_hospedaje_cotizacion');
    const montoCostosLogisticosHiddenEl = document.getElementById('monto_costos_logisticos_cotizacion_hidden');
    const displaySubtotalServiciosEl = document.getElementById('displaySubtotalServicios_integral');
    const displayCostosLogisticosEl = document.getElementById('displayCostosLogisticos_integral');
    const displaySubtotalGeneralEl = document.getElementById('displaySubtotalGeneral_integral');
    const displayDescuentoGlobalEl = document.getElementById('displayDescuentoGlobal_integral');
    const displayImpuestosEl = document.getElementById('displayImpuestos_integral');
    const displayTotalCotizadoEl = document.getElementById('displayTotalCotizado_integral');
    // const montoDescuentoGlobalInputEl = document.getElementById('monto_descuento_global_cotizacion'); // Ya no se usa para el cálculo directo
    // const montoImpuestosInputEl = document.getElementById('monto_impuestos_cotizacion'); // Ya no se usa para el cálculo directo


    function calcularYActualizarCostosLogisticosIntegral() {
        const transporte = parseFloat(costoTransporteInputEl.value) || 0;
        const viaticos = parseFloat(costoViaticosInputEl.value) || 0;
        const hospedaje = parseFloat(costoHospedajeInputEl.value) || 0;
        const totalLogistico = transporte + viaticos + hospedaje;
        if (montoCostosLogisticosHiddenEl) { 
             montoCostosLogisticosHiddenEl.value = totalLogistico.toFixed(2);
        }
        if(displayCostosLogisticosEl) displayCostosLogisticosEl.textContent = '+$' + totalLogistico.toFixed(2);
        return totalLogistico;
    }

    function calcularTotalesGeneralesIntegral() {
        let subtotalServicios = 0;
        if(formCotizacionIntegralEl){
            formCotizacionIntegralEl.querySelectorAll('.item-cotizacion-card').forEach(card => {
                const cantidadInput = card.querySelector('.input-cantidad-servicio-integral');
                const precioInput = card.querySelector('.input-precio-item-integral');
                const cantidad = parseFloat(cantidadInput.value) || 1.0;
                subtotalServicios += (parseFloat(precioInput.value) || 0) * cantidad;
            });
        }
        if(displaySubtotalServiciosEl) displaySubtotalServiciosEl.textContent = '$' + subtotalServicios.toFixed(2);

        const costosLogisticos = calcularYActualizarCostosLogisticosIntegral();
        const subtotalGeneral = subtotalServicios + costosLogisticos;
        if(displaySubtotalGeneralEl) displaySubtotalGeneralEl.textContent = '$' + subtotalGeneral.toFixed(2);

        // Cálculo con porcentajes para descuento e impuestos
        const porcentajeDescuento = parseFloat(porcentajeDescuentoGlobalInputEl.value) || 0;
        const montoDescuento = (subtotalGeneral * (porcentajeDescuento / 100));
        if(montoDescuentoGlobalCalculadoHiddenEl) montoDescuentoGlobalCalculadoHiddenEl.value = montoDescuento.toFixed(2);
        if(displayDescuentoGlobalEl) displayDescuentoGlobalEl.textContent = '-$' + montoDescuento.toFixed(2);

        const baseParaImpuestos = subtotalGeneral - montoDescuento;
        const porcentajeImpuestos = parseFloat(porcentajeImpuestosInputEl.value) || 0;
        const montoImpuestos = (baseParaImpuestos * (porcentajeImpuestos / 100));
        if(montoImpuestosCalculadoHiddenEl) montoImpuestosCalculadoHiddenEl.value = montoImpuestos.toFixed(2);
        if(displayImpuestosEl) displayImpuestosEl.textContent = '+$' + montoImpuestos.toFixed(2);

        const totalCotizado = baseParaImpuestos + montoImpuestos;
        if(displayTotalCotizadoEl) displayTotalCotizadoEl.textContent = '$' + totalCotizado.toFixed(2);
    }

    if (formCotizacionIntegralEl) {
        formCotizacionIntegralEl.addEventListener('input', function(event) {
            const target = event.target;
            if (target.classList.contains('input-precio-item-integral') ||
                target.classList.contains('input-cantidad-servicio-integral') ||
                target.id === 'costo_transporte_cotizacion' ||
                target.id === 'costo_viaticos_cotizacion' ||
                target.id === 'costo_hospedaje_cotizacion' ||
                target.id === 'porcentaje_descuento_global_cotizacion' || // Ahora es un porcentaje
                target.id === 'porcentaje_impuestos_cotizacion' ||      // Ahora es un porcentaje
                target.id === 'numero_invitados_proyecto' || 
                target.id === 'config_numero_invitados_este_servicio_integral' 
             ) {
                if (target.id === 'numero_invitados_proyecto' && displayInvitadosGeneralesEventoEl) {
                    const numInvProyectoVal = target.value || '1';
                    displayInvitadosGeneralesEventoEl.textContent = numInvProyectoVal;
                    if (chkUsarInvitadosGeneralesEventoEl && chkUsarInvitadosGeneralesEventoEl.checked && inputNumeroInvitadosEsteServicioEl) {
                        inputNumeroInvitadosEsteServicioEl.value = numInvProyectoVal;
                    }
                }
                calcularTotalesGeneralesIntegral();
            }
        });
        if (itemCotizacionIndex > 0) {
            calcularTotalesGeneralesIntegral();
        } else { // Calcular una vez al cargar la página, incluso si no hay ítems, para inicializar costos logísticos.
            calcularTotalesGeneralesIntegral();
        }
    }
});
</script>
{% endblock %}
