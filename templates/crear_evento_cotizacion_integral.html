{% extends "base.html" %}

{% block content %}
<form method="POST" action="{{ url_for('cotizaciones_bp.vista_crear_evento_cotizacion_integral') }}" class="styled-form" id="formCrearEventoCotizacionIntegral">
    
    {# --- Sección 1: Información General del Evento (Proyecto) --- #}
    <fieldset class="form-section">
        <legend><h4>Paso 1: Datos del Evento (Proyecto)</h4></legend>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="identificador_evento">Identificador Único del Evento: <span class="required-indicator">*</span></label>
                <input type="text" name="identificador_evento" id="identificador_evento"
                       value="{{ form_data.identificador_evento or '' }}" required>
                <small class="form-text text-muted">Ej: "graduacion_ana_2025". Sin espacios.</small>
            </div>
            <div class="form-group">
                <label for="nombre_evento">Nombre del Evento: <span class="required-indicator">*</span></label>
                <input type="text" name="nombre_evento" id="nombre_evento"
                       value="{{ form_data.nombre_evento or '' }}" required>
            </div>
        </div>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="fecha_evento">Fecha del Evento: <span class="required-indicator">*</span></label>
                <input type="date" name="fecha_evento" id="fecha_evento"
                       value="{{ form_data.fecha_evento or fecha_hoy }}" required>
            </div>
            <div class="form-group">
                <label for="numero_invitados_proyecto">Número de Invitados (General del Evento): <span class="required-indicator">*</span></label>
                <input type="number" name="numero_invitados_proyecto" id="numero_invitados_proyecto"
                       value="{{ form_data.numero_invitados_proyecto or '1' }}" min="1" required>
                <small>Este será el número de invitados por defecto para los servicios.</small>
            </div>
        </div>
        <h5 class="form-section-subtitle">Información del Cliente</h5>
        <div class="form-group">
            <label for="cliente_nombre">Nombre del Cliente:</label>
            <input type="text" name="cliente_nombre" id="cliente_nombre"
                   value="{{ form_data.cliente_nombre or '' }}">
        </div>
        <div class="form-grid-2col">
            <div class="form-group">
                <label for="cliente_telefono">Teléfono del Cliente:</label>
                <input type="tel" name="cliente_telefono" id="cliente_telefono"
                       value="{{ form_data.cliente_telefono or '' }}">
            </div>
            <div class="form-group">
                <label for="cliente_email">Email del Cliente:</label>
                <input type="email" name="cliente_email" id="cliente_email"
                       value="{{ form_data.cliente_email or '' }}">
            </div>
        </div>
        <h5 class="form-section-subtitle">Detalles de Ubicación (Proyecto)</h5>
        <div class="form-group">
            <label for="direccion_evento">Dirección del Evento:</label>
            <input type="text" name="direccion_evento" id="direccion_evento" value="{{ form_data.direccion_evento or '' }}">
        </div>
        <div class="form-group">
            <label for="tipo_ubicacion">Tipo de Ubicación:</label>
            <select name="tipo_ubicacion" id="tipo_ubicacion">
                <option value="Local (CDMX y Área Metropolitana)" {% if form_data.tipo_ubicacion == 'Local (CDMX y Área Metropolitana)' or not form_data.tipo_ubicacion %}selected{% endif %}>Local (CDMX y Área Metropolitana)</option>
                <option value="Foráneo (Interior de la República)" {% if form_data.tipo_ubicacion == 'Foráneo (Interior de la República)' %}selected{% endif %}>Foráneo (Interior de la República)</option>
                <option value="Foráneo (Internacional)" {% if form_data.tipo_ubicacion == 'Foráneo (Internacional)' %}selected{% endif %}>Foráneo (Internacional)</option>
                <option value="Otro" {% if form_data.tipo_ubicacion == 'Otro' %}selected{% endif %}>Otro</option>
            </select>
        </div>
        <div class="form-group">
            <label for="notas_proyecto">Notas Adicionales del Proyecto:</label>
            <textarea name="notas_proyecto" id="notas_proyecto" rows="2">{{ form_data.notas_proyecto or '' }}</textarea>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Paso 2: Datos Generales de la Cotización (V1)</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="fecha_emision_cotizacion">Fecha de Emisión: <span class="required-indicator">*</span></label>
                <input type="date" name="fecha_emision_cotizacion" id="fecha_emision_cotizacion"
                       value="{{ form_data.fecha_emision_cotizacion or fecha_hoy }}" required>
            </div>
            <div class="form-group">
                <label for="fecha_validez_cotizacion">Válida Hasta (Opcional):</label>
                <input type="date" name="fecha_validez_cotizacion" id="fecha_validez_cotizacion"
                       value="{{ form_data.fecha_validez_cotizacion or '' }}">
            </div>
            <div class="form-group">
                <label for="estado_cotizacion">Estado de la Cotización:</label>
                <select name="estado_cotizacion" id="estado_cotizacion">
                    <option value="Borrador" {% if form_data.estado_cotizacion == 'Borrador' or not form_data.estado_cotizacion %}selected{% endif %}>Borrador</option>
                    <option value="Presentada" {% if form_data.estado_cotizacion == 'Presentada' %}selected{% endif %}>Presentada</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Paso 3: Añadir Servicios a la Cotización</h4></legend>
        <p class="subtle-text">Selecciona un tipo de servicio, paquete y perfil. Luego, define los invitados para este servicio y configura sus componentes antes de añadirlo.</p>

        <div class="form-grid-3col" style="margin-bottom: 20px;">
            <div class="form-group">
                <label for="select_tipo_servicio_base_integral">1. Tipo de Servicio:</label>
                <select id="select_tipo_servicio_base_integral" class="form-control">
                    <option value="">-- Selecciona Tipo --</option>
                    {% for tsb in todos_tipos_servicio_base_activos %}
                        <option value="{{ tsb.id_tipo_servicio_base }}">{{ tsb.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="select_nivel_paquete_integral">2. Nivel de Paquete:</label>
                <select id="select_nivel_paquete_integral" class="form-control" disabled>
                    <option value="">-- Selecciona Paquete --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="select_nivel_perfil_integral">3. Nivel de Perfil:</label>
                <select id="select_nivel_perfil_integral" class="form-control" disabled>
                    <option value="">-- Selecciona Perfil --</option>
                </select>
            </div>
        </div>

        <div id="info_variante_seleccionada_integral" class="selected-product-info-box-compact" style="display:none; margin-bottom:15px; background-color: #e6fff3; border-color: #b3ffda;">
            Variante Seleccionada: <strong id="nombre_variante_display_integral"></strong> (ID: <span id="id_variante_display_integral"></span>)
        </div>

        <div id="config_invitados_para_servicio_actual_container" style="display:none !important; margin-top: 15px; margin-bottom:15px; padding:15px; border: 1px solid #e0e4e8; border-radius: var(--radio-borde-general); background-color: #f9fafb;">
            <h6 style="margin-top:0; margin-bottom:10px; font-weight:500;">Invitados para este Servicio Específico:</h6>
            <div class="form-group">
                <label for="config_usar_invitados_generales_evento" class="checkbox-label-inline">
                    <input type="checkbox" id="config_usar_invitados_generales_evento" checked>
                    Aplicar invitados generales del evento (<span id="config_display_invitados_generales_evento">N/A</span>)
                </label>
            </div>
            <div class="form-group" id="config_campo_invitados_especificos_servicio" style="display:none; margin-top: 8px;">
                <label for="config_numero_invitados_este_servicio">Número de invitados para ESTE servicio:</label>
                <input type="number" id="config_numero_invitados_este_servicio" min="1" class="form-control" style="width: 100px;">
            </div>
        </div>

        <div id="contenedor_grupos_columnas_integral" class="opciones-servicio-container-columnas" style="display:none;">
            {# Aquí se cargarán dinámicamente los grupos y opciones #}
        </div>
        
        <div id="acciones_servicio_configurable_integral" style="margin-top: 20px; display:none;">
             <button type="button" id="btnAnadirServicioConfiguradoComoItem_integral" class="button button-primary">
                Añadir este Servicio Configurado a la Cotización
            </button>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Ítems de la Cotización</h4></legend>
        <div id="items-cotizacion-container-integral">
            {# Los ítems se añadirán aquí con JavaScript #}
        </div>
        <p id="noItemsCotizacionMessage_integral" style="text-align:center; padding:10px;">
            Aún no has añadido ítems a esta cotización.
        </p>
    </fieldset>

    <fieldset class="form-section">
        <legend><h4>Costos Logísticos y Totales de la Cotización</h4></legend>
        <div class="form-grid-3col">
            <div class="form-group">
                <label for="costo_transporte_cotizacion">Costo Transporte ($):</label>
                <input type="number" step="0.01" name="costo_transporte_cotizacion" id="costo_transporte_cotizacion"
                       value="{{ form_data.costo_transporte_cotizacion or '0.00' }}" min="0">
            </div>
            <div class="form-group">
                <label for="costo_viaticos_cotizacion">Costo Viáticos ($):</label>
                <input type="number" step="0.01" name="costo_viaticos_cotizacion" id="costo_viaticos_cotizacion"
                       value="{{ form_data.costo_viaticos_cotizacion or '0.00' }}" min="0">
            </div>
            <div class="form-group">
                <label for="costo_hospedaje_cotizacion">Costo Hospedaje ($):</label>
                <input type="number" step="0.01" name="costo_hospedaje_cotizacion" id="costo_hospedaje_cotizacion"
                       value="{{ form_data.costo_hospedaje_cotizacion or '0.00' }}" min="0">
            </div>
        </div>
        <input type="hidden" name="monto_costos_logisticos_cotizacion" id="monto_costos_logisticos_cotizacion_hidden">

        <div class="form-grid-2col" style="margin-top:15px;">
            <div class="form-group">
                <label for="monto_descuento_global_cotizacion">Descuento Global ($):</label>
                <input type="number" step="0.01" name="monto_descuento_global_cotizacion" id="monto_descuento_global_cotizacion"
                       value="{{ form_data.monto_descuento_global_cotizacion or '0.00' }}" min="0">
            </div>
            <div class="form-group">
                <label for="monto_impuestos_cotizacion">Impuestos (ej. IVA) ($):</label>
                <input type="number" step="0.01" name="monto_impuestos_cotizacion" id="monto_impuestos_cotizacion"
                       value="{{ form_data.monto_impuestos_cotizacion or '0.00' }}" min="0">
            </div>
        </div>
        <hr style="margin: 20px 0;">
        <div class="resumen-totales" style="text-align: right; font-size: 1.1em;">
            <p>Subtotal Servicios/Productos: <strong id="displaySubtotalServicios_integral">$0.00</strong></p>
            <p>Costos Logísticos: <strong id="displayCostosLogisticos_integral">+$0.00</strong></p>
            <p>Subtotal General: <strong id="displaySubtotalGeneral_integral">$0.00</strong></p>
            <p style="color: var(--color-peligro);">Menos Descuento Global: <strong id="displayDescuentoGlobal_integral">-$0.00</strong></p>
            <p>Más Impuestos: <strong id="displayImpuestos_integral">+$0.00</strong></p>
            <h4 style="margin-top:10px; font-size: 1.3em;">TOTAL COTIZADO: <strong id="displayTotalCotizado_integral" style="color: var(--color-acento-secundario);">$0.00</strong></h4>
        </div>
    </fieldset>

     <fieldset class="form-section">
        <legend><h4>Términos, Condiciones y Notas Adicionales (Cotización)</h4></legend>
        <div class="form-group">
            <label for="terminos_condiciones_cotizacion">Términos y Condiciones:</label>
            <textarea name="terminos_condiciones_cotizacion" id="terminos_condiciones_cotizacion" rows="4">{{ form_data.terminos_condiciones_cotizacion or '' }}</textarea>
        </div>
        <div class="form-group">
            <label for="notas_cotizacion_internas">Notas Internas de la Cotización (no visibles al cliente):</label>
            <textarea name="notas_cotizacion_internas" id="notas_cotizacion_internas" rows="2">{{ form_data.notas_cotizacion_internas or '' }}</textarea>
        </div>
    </fieldset>

    <div class="form-actions">
        <a href="{{ url_for('proyectos_bp.vista_listar_proyectos') }}" class="button button-secondary">Cancelar Todo</a>
        <button type="submit" name="accion" value="guardar_finalizar" class="button button-primary">
            Crear Evento y Finalizar Cotización
        </button>
    </div>
</form>

<style>
    /* Estilos generales del formulario ya definidos en style.css o base.html */
    .form-section-subtitle { 
        font-size: 0.95em; font-weight: 600; color: var(--color-texto-principal);
        margin-top: 20px; margin-bottom: 12px; padding-bottom: 5px;
        border-bottom: 1px solid var(--color-borde-sutil);
    }
    .subtle-text { font-size: 0.9em; color: var(--color-texto-secundario); line-height: 1.5; }
    .required-indicator { color: var(--color-peligro); font-weight: bold; margin-left: 2px; }
    
    /* ESTILO PARA EL CONTENEDOR DE GRUPOS DE COMPONENTES */
    .opciones-servicio-container-columnas {
        display: flex; 
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0; 
        border-radius: var(--radio-borde-general);
        margin-top: 15px; 
        background-color: #ffffff; 
    }
    .grupo-columna { 
        flex-basis: 280px; 
        flex-grow: 1; 
        padding: 15px;
        border: 1px solid #d1d5db; 
        border-radius: var(--radio-borde-general);
        background-color: #ffffff; 
        box-shadow: var(--sombra-caja-ligera);
    }
    .grupo-columna h6 {
        font-size: 1.05em; font-weight: 600; color: var(--color-texto-principal);
        margin-top: 0; margin-bottom: 12px; padding-bottom: 8px;
        border-bottom: 1px solid var(--color-borde-sutil);
    }
    .grupo-columna .opcion-checkbox-item { display: block; margin-bottom: 10px; }
    .grupo-columna .opcion-checkbox-item label {
        font-size: 0.9em; color: var(--color-texto-secundario);
        display: flex; align-items: center; cursor: pointer;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"] {
        margin-right: 8px; height: 16px; width: 16px;
    }
    .grupo-columna .opcion-checkbox-item input[type="checkbox"]:disabled + span {
        color: #b0b0b0; text-decoration: line-through;
    }
     .grupo-columna .opcion-checkbox-item label:has(input[type="checkbox"]:disabled) {
        cursor: not-allowed; opacity: 0.6;
    }

    .selected-product-info-box-compact {
        margin-top: 5px; padding: 8px 12px; background-color: #eef3f7;
        border: 1px solid #d1dce5; border-radius: var(--radio-borde-general);
        font-size: 0.85em; color: var(--color-texto-secundario);
    }
    .selected-product-info-box-compact strong { color: var(--color-texto-principal); font-weight: 500;}
    
    .item-cotizacion-card {
        background-color: #fff; border: 1px solid #e0e0e0;
        border-radius: var(--radio-borde-general); padding: 15px;
        margin-bottom: 15px; box-shadow: var(--sombra-caja-ligera);
    }
    .item-cotizacion-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;
    }
    .item-cotizacion-header .item-nombre-display {
        margin: 0; flex-grow: 1; font-size: 1.1em;
        font-weight: 600; color: var(--color-texto-principal);
    }
    .input-inline-editable {
        border: none; background-color: transparent; padding: 2px 5px;
        font-size: inherit; font-weight: inherit; color: inherit;
        width: calc(100% - 10px); box-shadow: none;
    }
    .input-inline-editable:focus {
        background-color: #f0f8ff; border: 1px solid var(--color-borde-input);
    }
    .button.button-danger-small.remove-item-cotizacion-btn {
        background-color: var(--color-peligro); color: white;
        border: 1px solid var(--color-peligro); padding: 6px 12px;
        font-size: 0.85em;
    }
     .componentes-seleccionados-display-container {
        margin-top: 15px; padding: 12px 15px; background-color: #f8f9fa;
        border: 1px solid #e9ecef; border-radius: var(--radio-borde-general); font-size: 0.9em;
    }
    .componentes-display-titulo {
        display: block; font-weight: 600; color: var(--color-texto-principal);
        margin-bottom: 8px; font-size: 0.95em;
    }
    .componentes-display-lista { list-style-type: none; padding-left: 0; margin-bottom: 0; }
    .componentes-display-item {
        padding: 5px 0; color: var(--color-texto-secundario);
        border-bottom: 1px dotted #e0e0e0; display: flex;
        justify-content: space-between; align-items: center;
    }
    .componentes-display-item:last-child { border-bottom: none; }
    .componente-cantidad-display {
        font-size: 0.9em; color: #555; background-color: #e9ecef;
        padding: 2px 6px; border-radius: 4px;
    }
    .componentes-display-none { color: #777; font-style: italic; padding: 5px 0; }
    
    .checkbox-label-inline { 
        display: flex;
        align-items: center;
        font-weight: normal !important;
        font-size: 0.9em !important;
    }
    .checkbox-label-inline input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(0.9); 
    }
    
    #config_invitados_para_servicio_actual_container {
        /* Los estilos de layout como márgenes, padding, borde, etc., están definidos inline en el HTML. */
        /* La propiedad 'display' es controlada por JavaScript y el estilo inline del elemento para mostrar/ocultar dinámicamente. */
        /* Se elimina 'display: block !important;' de aquí para evitar conflictos y permitir control por JS. */
    }
    #config_invitados_para_servicio_actual_container h6 {
        font-size: 1em;
    }
    #config_invitados_para_servicio_actual_container .form-group {
        margin-bottom: 8px; 
    }
    #config_invitados_para_servicio_actual_container .form-group:last-child {
        margin-bottom: 0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM integral cargado (v12_styles_fixed). Verificando elementos...");

    const selectTipoServicio = document.getElementById('select_tipo_servicio_base_integral');
    const selectNivelPaquete = document.getElementById('select_nivel_paquete_integral');
    const selectNivelPerfil = document.getElementById('select_nivel_perfil_integral');
    const infoVarianteDiv = document.getElementById('info_variante_seleccionada_integral');
    const nombreVarianteDisplay = document.getElementById('nombre_variante_display_integral');
    const idVarianteDisplay = document.getElementById('id_variante_display_integral');
    
    const configInvitadosServicioContainer = document.getElementById('config_invitados_para_servicio_actual_container');
    const chkUsarInvitadosGeneralesEvento = document.getElementById('config_usar_invitados_generales_evento');
    const displayInvitadosGeneralesEvento = document.getElementById('config_display_invitados_generales_evento');
    const campoInvitadosEspecificosServicio = document.getElementById('config_campo_invitados_especificos_servicio');
    const inputNumeroInvitadosEsteServicio = document.getElementById('config_numero_invitados_este_servicio');
    
    const contenedorGruposColumnas = document.getElementById('contenedor_grupos_columnas_integral');
    const accionesServicioConfigurableDiv = document.getElementById('acciones_servicio_configurable_integral');
    const btnAnadirServicioConfigurado = document.getElementById('btnAnadirServicioConfiguradoComoItem_integral');
    const itemsCotizacionContainer = document.getElementById('items-cotizacion-container-integral');
    const noItemsMessage = document.getElementById('noItemsCotizacionMessage_integral');
    let itemCotizacionIndex = 0; 

    let currentConfiguredVariant = null;
    let currentConfiguredVariantEstructura = null;
    const inputInvitadosProyecto = document.getElementById('numero_invitados_proyecto');

    // Verificaciones iniciales
    if (!selectTipoServicio) console.error("select_tipo_servicio_base_integral NO ENCONTRADO");
    if (!selectNivelPaquete) console.error("select_nivel_paquete_integral NO ENCONTRADO");
    if (!selectNivelPerfil) console.error("select_nivel_perfil_integral NO ENCONTRADO");
    if (!infoVarianteDiv) console.error("info_variante_seleccionada_integral NO ENCONTRADO.");
    if (!configInvitadosServicioContainer) console.error("config_invitados_para_servicio_actual_container NO ENCONTRADO.");
    if (!contenedorGruposColumnas) console.error("¡CRÍTICO! contenedor_grupos_columnas_integral NO ENCONTRADO.");
    if (!accionesServicioConfigurableDiv) console.error("acciones_servicio_configurable_integral NO ENCONTRADO.");
    if (!inputInvitadosProyecto) console.error("numero_invitados_proyecto NO ENCONTRADO.");


    function populateSelect(selectElement, options, placeholder) {
        console.log(`PopulateSelect: Elemento: ${selectElement.id}, Placeholder: "${placeholder}", Opciones:`, options);
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        if (options && Array.isArray(options) && options.length > 0) {
            options.forEach(option => {
                const value = typeof option === 'object' ? option.id : option;
                const text = typeof option === 'object' ? option.nombre : option;
                selectElement.add(new Option(text, value));
            });
            selectElement.disabled = false;
            console.log(`${selectElement.id} habilitado y poblado.`);
        } else {
            console.warn(`PopulateSelect: No hay opciones válidas para ${selectElement.id}. Se mantiene deshabilitado.`);
            selectElement.disabled = true;
        }
    }

    if (selectTipoServicio) {
        selectTipoServicio.addEventListener('change', async function() {
            console.log("Tipo de Servicio - Valor cambiado a:", this.value);
            const tipoBaseId = this.value;
            
            populateSelect(selectNivelPaquete, [], '-- Selecciona Paquete --');
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainer) {
                configInvitadosServicioContainer.style.display = 'none'; 
                configInvitadosServicioContainer.classList.remove('opciones-servicio-container-columnas'); 
            }
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.style.display = 'none'; 
                contenedorGruposColumnas.innerHTML = '';
                contenedorGruposColumnas.classList.remove('opciones-servicio-container-columnas');
            }
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null;
            currentConfiguredVariantEstructura = null;

            if (tipoBaseId) {
                console.log("API Call: Fetching paquetes para tipo base ID:", tipoBaseId);
                const urlApiPaquetes = `{{ url_for('admin_servicios_bp.api_get_niveles_paquete') }}?id_tipo_base=${tipoBaseId}`;
                try {
                    const response = await fetch(urlApiPaquetes);
                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error("Error API (paquetes):", response.status, errorData);
                        throw new Error(`Error al cargar paquetes: ${response.status}`);
                    }
                    const paquetes = await response.json();
                    console.log("API Response (paquetes):", paquetes);
                    populateSelect(selectNivelPaquete, paquetes, '-- Selecciona Paquete --');
                } catch (error) { 
                    console.error("Excepción en fetch (paquetes):", error);
                }
            }
        });
    }

    if (selectNivelPaquete) {
        selectNivelPaquete.addEventListener('change', async function() {
            console.log("Nivel de Paquete - Valor cambiado a:", this.value);
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = this.value;
            populateSelect(selectNivelPerfil, [], '-- Selecciona Perfil --');
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            if(configInvitadosServicioContainer) {
                configInvitadosServicioContainer.style.display = 'none';
                configInvitadosServicioContainer.classList.remove('opciones-servicio-container-columnas');
            }
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.style.display = 'none';
                contenedorGruposColumnas.innerHTML = '';
                contenedorGruposColumnas.classList.remove('opciones-servicio-container-columnas');
            }
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null;
            currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre) {
                console.log("API Call: Fetching perfiles para tipo:", tipoBaseId, "paquete:", paqueteNombre);
                const urlApiPerfiles = `{{ url_for('admin_servicios_bp.api_get_niveles_perfil') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}`;
                try {
                    const response = await fetch(urlApiPerfiles);
                    if (!response.ok) {
                        console.error("Error API (perfiles):", response.status, await response.text());
                        throw new Error('Error al cargar perfiles');
                    }
                    const perfiles = await response.json();
                    console.log("API Response (perfiles):", perfiles);
                    populateSelect(selectNivelPerfil, perfiles, '-- Selecciona Perfil --');
                } catch (error) { 
                    console.error("Excepción en fetch (perfiles):", error);
                }
            }
        });
    }
    
    if (selectNivelPerfil) {
        selectNivelPerfil.addEventListener('change', async function() {
            console.log("Nivel de Perfil - Valor cambiado a:", this.value);
            const tipoBaseId = selectTipoServicio.value;
            const paqueteNombre = selectNivelPaquete.value;
            const perfilNombre = this.value; 
            
            if(infoVarianteDiv) infoVarianteDiv.style.display = 'none';
            
            if(configInvitadosServicioContainer) { 
                configInvitadosServicioContainer.style.display = 'none'; // Ocultar inicialmente al cambiar perfil
                configInvitadosServicioContainer.classList.remove('opciones-servicio-container-columnas'); 
            }
            
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.style.display = 'none'; 
                contenedorGruposColumnas.innerHTML = ''; 
                contenedorGruposColumnas.classList.remove('opciones-servicio-container-columnas');
            }
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none';
            currentConfiguredVariant = null;
            currentConfiguredVariantEstructura = null;

            if (tipoBaseId && paqueteNombre && perfilNombre) {
                console.log("API Call: Buscando variante para:", tipoBaseId, paqueteNombre, perfilNombre);
                const urlApiBuscarVariante = `{{ url_for('admin_servicios_bp.api_buscar_variante_por_niveles') }}?id_tipo_base=${tipoBaseId}&paquete=${encodeURIComponent(paqueteNombre)}&perfil=${encodeURIComponent(perfilNombre)}`;
                try {
                    const response = await fetch(urlApiBuscarVariante);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Error API (buscar_variante):", response.status, errorText);
                        if(infoVarianteDiv) {
                            infoVarianteDiv.innerHTML = `<p style="color:red;">Variante no encontrada (API status: ${response.status}).</p>`;
                            infoVarianteDiv.style.display = 'block';
                        }
                        return; 
                    }
                    const varianteData = await response.json();
                    console.log("API Response (buscar_variante):", varianteData);

                    if (varianteData && varianteData.id_variante_config) {
                        currentConfiguredVariant = varianteData;
                        if(nombreVarianteDisplay) nombreVarianteDisplay.textContent = varianteData.nombre_variante;
                        if(idVarianteDisplay) idVarianteDisplay.textContent = varianteData.id_variante_config;
                        if(infoVarianteDiv) infoVarianteDiv.style.display = 'block';
                        
                        if(configInvitadosServicioContainer) { // Mostrar SOLO SI se encontró variante válida
                            const numInvProyecto = inputInvitadosProyecto.value || '1';
                            if(displayInvitadosGeneralesEvento) displayInvitadosGeneralesEvento.textContent = numInvProyecto;
                            if(inputNumeroInvitadosEsteServicio) inputNumeroInvitadosEsteServicio.value = numInvProyecto;
                            if(chkUsarInvitadosGeneralesEvento) chkUsarInvitadosGeneralesEvento.checked = true; 
                            if(campoInvitadosEspecificosServicio) campoInvitadosEspecificosServicio.style.display = 'none';
                            
                            configInvitadosServicioContainer.classList.remove('opciones-servicio-container-columnas'); 
                            configInvitadosServicioContainer.style.display = 'block'; 
                            console.log("Contenedor de Invitados - display: block, classList:", configInvitadosServicioContainer.classList);
                        }
                        
                        cargarEstructuraVariante(varianteData.id_variante_config); 
                    } else { 
                        if(infoVarianteDiv) {
                            infoVarianteDiv.innerHTML = `<p style="color:red;">No se encontró una variante activa para esta combinación (datos vacíos o sin ID).</p>`;
                            infoVarianteDiv.style.display = 'block';
                        }
                         console.warn("No se encontró variante o ID de variante en los datos:", varianteData);
                    }
                } catch (error) { 
                    console.error("Excepción buscando variante:", error);
                     if(infoVarianteDiv) {
                        infoVarianteDiv.innerHTML = `<p style="color:red;">Error al buscar variante: ${error.message}</p>`;
                        infoVarianteDiv.style.display = 'block';
                    }
                }
            }
        });
    }

    if (chkUsarInvitadosGeneralesEvento && campoInvitadosEspecificosServicio && inputNumeroInvitadosEsteServicio && inputInvitadosProyecto && displayInvitadosGeneralesEvento) {
        chkUsarInvitadosGeneralesEvento.addEventListener('change', function() {
            if (this.checked) {
                campoInvitadosEspecificosServicio.style.display = 'none';
                inputNumeroInvitadosEsteServicio.value = inputInvitadosProyecto.value || '1';
            } else {
                campoInvitadosEspecificosServicio.style.display = 'block';
                inputNumeroInvitadosEsteServicio.focus();
            }
        });
    }
    if (inputInvitadosProyecto && displayInvitadosGeneralesEvento && chkUsarInvitadosGeneralesEvento && inputNumeroInvitadosEsteServicio) {
        inputInvitadosProyecto.addEventListener('input', function() {
            const numInv = this.value || '1';
            displayInvitadosGeneralesEvento.textContent = numInv;
            if (chkUsarInvitadosGeneralesEvento.checked) {
                inputNumeroInvitadosEsteServicio.value = numInv;
            }
        });
        const numInvInicial = inputInvitadosProyecto.value || '1';
        displayInvitadosGeneralesEvento.textContent = numInvInicial;
        inputNumeroInvitadosEsteServicio.value = numInvInicial;
    }

    async function cargarEstructuraVariante(idVariante) {
        console.log("Cargando estructura para variante ID:", idVariante);
        if(!contenedorGruposColumnas || !accionesServicioConfigurableDiv) {
            console.error("Error: contenedores de grupos o acciones no encontrados en cargarEstructuraVariante.");
            return;
        }
        
        contenedorGruposColumnas.innerHTML = '';
        contenedorGruposColumnas.style.display = 'none'; 
        contenedorGruposColumnas.classList.add('opciones-servicio-container-columnas');

        try {
            const response = await fetch(`{{ url_for('admin_servicios_bp.api_get_estructura_variante') }}?id_variante_config=${idVariante}`);
            if (!response.ok) {
                console.error("Error API get_estructura_variante:", response.status, await response.text());
                throw new Error('Error al cargar estructura de la variante desde API');
            }
            currentConfiguredVariantEstructura = await response.json();
            console.log("Estructura de variante recibida:", currentConfiguredVariantEstructura);
            
            renderizarGruposEnColumnas(currentConfiguredVariantEstructura.grupos); 
            
            if(contenedorGruposColumnas) {
                console.log("Intentando mostrar contenedorGruposColumnas. Clase actual:", contenedorGruposColumnas.className);
                contenedorGruposColumnas.style.display = 'flex'; 
                console.log("Visibilidad de contenedorGruposColumnas establecida a flex.");
            }
            
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'block';
            console.log("Contenedor de grupos y acciones DEBERÍAN estar visibles si hay contenido.");

        } catch (error) {
            console.error("Excepción cargando estructura variante:", error);
            if(contenedorGruposColumnas) {
                contenedorGruposColumnas.innerHTML = `<p style="color:red;">Error al cargar opciones de componentes: ${error.message}</p>`;
                contenedorGruposColumnas.style.display = 'block'; 
            }
            if(accionesServicioConfigurableDiv) accionesServicioConfigurableDiv.style.display = 'none'; 
        }
    }

    function renderizarGruposEnColumnas(grupos) {
        console.log("Renderizando grupos en columnas. Grupos:", grupos);
        if(!contenedorGruposColumnas) {
            console.error("ERROR FATAL: contenedor_grupos_columnas_integral no existe en renderizarGruposEnColumnas.");
            return;
        }
        contenedorGruposColumnas.innerHTML = ''; 
        if (!grupos || grupos.length === 0) {
            contenedorGruposColumnas.innerHTML = '<p>Esta variante no tiene grupos de componentes configurados.</p>';
            console.log("No hay grupos para renderizar. Contenedor de grupos se mostrará con este mensaje.");
            contenedorGruposColumnas.style.display = 'block'; 
            return;
        }
        grupos.forEach(grupo => {
            const divColumnaGrupo = document.createElement('div');
            divColumnaGrupo.classList.add('grupo-columna');
            divColumnaGrupo.dataset.idGrupo = grupo.id_grupo_config;
            divColumnaGrupo.dataset.opcionesPermitidas = grupo.opciones_permitidas_seleccionables;
            const h6 = document.createElement('h6');
            h6.textContent = `${grupo.nombre_grupo} (Elige ${grupo.opciones_permitidas_seleccionables})`;
            divColumnaGrupo.appendChild(h6);
            if (grupo.opciones_disponibles && grupo.opciones_disponibles.length > 0) {
                grupo.opciones_disponibles.forEach(opcion => {
                    const divOpcion = document.createElement('div');
                    divOpcion.classList.add('opcion-checkbox-item');
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `config_grupo_opcion_${grupo.id_grupo_config}`; 
                    checkbox.value = opcion.id_opcion_componente;
                    checkbox.dataset.nombreOpcion = opcion.nombre_display_cliente;
                    checkbox.dataset.cantidadConsumoBase = opcion.cantidad_consumo_base;
                    checkbox.dataset.unidadConsumoBase = opcion.unidad_consumo_base;
                    checkbox.dataset.idProductoInterno = opcion.producto_info ? opcion.producto_info.id_producto_interno : '';
                    checkbox.dataset.unidadProductoBase = opcion.producto_info ? opcion.producto_info.unidad_medida_base : opcion.unidad_consumo_base;
                    checkbox.dataset.productoEsIndivisible = opcion.producto_info ? opcion.producto_info.es_indivisible : (opcion.unidad_consumo_base.toLowerCase() === 'pieza');

                    const span = document.createElement('span');
                    span.textContent = ` ${opcion.nombre_display_cliente} (${opcion.cantidad_consumo_base} ${opcion.unidad_consumo_base})`;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    divOpcion.appendChild(label);
                    divColumnaGrupo.appendChild(divOpcion);
                });
            } else {
                divColumnaGrupo.innerHTML += '<p class="text-xs text-gray-500">No hay opciones en este grupo.</p>';
            }
            contenedorGruposColumnas.appendChild(divColumnaGrupo);
        });
        console.log("Grupos renderizados.");
        aplicarLogicaCheckboxesDinamicosConfigIntegral();
    }

    function aplicarLogicaCheckboxesDinamicosConfigIntegral() {
        if (!contenedorGruposColumnas) return;
        document.querySelectorAll('#contenedor_grupos_columnas_integral .grupo-columna').forEach(grupoDiv => {
            const checkboxesEnGrupo = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]'));
            const maxSeleccionables = parseInt(grupoDiv.dataset.opcionesPermitidas);
            checkboxesEnGrupo.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const seleccionadosActual = checkboxesEnGrupo.filter(cb => cb.checked).length;
                    if (seleccionadosActual >= maxSeleccionables) {
                        checkboxesEnGrupo.forEach(cb => {
                            if (!cb.checked) {
                                cb.disabled = true;
                                const label = cb.closest('label');
                                if (label) label.classList.add('opacity-60', 'cursor-not-allowed');
                            }
                        });
                    } else {
                        checkboxesEnGrupo.forEach(cb => {
                            cb.disabled = false;
                            const label = cb.closest('label');
                            if (label) label.classList.remove('opacity-60', 'cursor-not-allowed');
                        });
                    }
                });
            });
        });
    }

    const btnAnadirServicioConfiguradoEl = document.getElementById('btnAnadirServicioConfiguradoComoItem_integral');
    if (btnAnadirServicioConfiguradoEl) {
        btnAnadirServicioConfiguradoEl.addEventListener('click', function() {
            if (!currentConfiguredVariant || !currentConfiguredVariant.id_variante_config || !currentConfiguredVariantEstructura) {
                alert("Por favor, selecciona y configura un servicio completamente primero (Tipo, Paquete, Perfil).");
                return;
            }

            let numeroInvitadosParaEsteServicio;
            if (chkUsarInvitadosGeneralesEvento.checked) {
                numeroInvitadosParaEsteServicio = parseInt(inputInvitadosProyecto.value) || 1;
            } else {
                numeroInvitadosParaEsteServicio = parseInt(inputNumeroInvitadosEsteServicio.value) || 1;
            }
            if (numeroInvitadosParaEsteServicio < 1) numeroInvitadosParaEsteServicio = 1;

            const componentesSeleccionadosParaItem = [];
            let detalleHtmlComponentes = '';
            
            const totalGruposDisponiblesEnVariante = currentConfiguredVariantEstructura.grupos.length;
            let numeroDeGruposConSeleccionesEnVariante = 0;
            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (grupoDiv && grupoDiv.querySelectorAll('input[type="checkbox"]:checked').length > 0) {
                    numeroDeGruposConSeleccionesEnVariante++;
                }
            });

            let factorAjusteGlobalDeGrupos = 1.0;
            if (numeroDeGruposConSeleccionesEnVariante > 0 && numeroDeGruposConSeleccionesEnVariante < totalGruposDisponiblesEnVariante) {
                factorAjusteGlobalDeGrupos = totalGruposDisponiblesEnVariante / numeroDeGruposConSeleccionesEnVariante;
            }

            currentConfiguredVariantEstructura.grupos.forEach(grupo => {
                const grupoDiv = contenedorGruposColumnas.querySelector(`.grupo-columna[data-id-grupo="${grupo.id_grupo_config}"]`);
                if (!grupoDiv) return;

                const opcionesPermitidasEnGrupo = parseInt(grupoDiv.dataset.opcionesPermitidas);
                const checkboxesSeleccionados = Array.from(grupoDiv.querySelectorAll('input[type="checkbox"]:checked'));
                const numOpcionesRealmenteElegidasEnGrupo = checkboxesSeleccionados.length;
                
                if (numOpcionesRealmenteElegidasEnGrupo === 0) return; 
                
                const factorAjusteIntraGrupo = opcionesPermitidasEnGrupo / numOpcionesRealmenteElegidasEnGrupo;

                checkboxesSeleccionados.forEach(chk => {
                    const opcionOriginal = grupo.opciones_disponibles.find(o => o.id_opcion_componente == chk.value);
                    if (!opcionOriginal) return;

                    let cantidadConsumoBase = parseFloat(opcionOriginal.cantidad_consumo_base);
                    let cantidadAjustadaPorPersonaBruta = cantidadConsumoBase * factorAjusteIntraGrupo * factorAjusteGlobalDeGrupos;
                    let unidadFinal = opcionOriginal.producto_info ? opcionOriginal.producto_info.unidad_medida_base : opcionOriginal.unidad_consumo_base;
                    let esIndivisible = opcionOriginal.producto_info ? opcionOriginal.producto_info.es_indivisible : (unidadFinal && unidadFinal.toLowerCase() === 'pieza');
                    let cantidadAjustadaPersonaFinal; 
                    if (esIndivisible) {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta);
                    } else {
                        cantidadAjustadaPersonaFinal = Math.ceil(cantidadAjustadaPorPersonaBruta / 5) * 5;
                    }
                    let cantidadTotalEventoFinal = cantidadAjustadaPersonaFinal * numeroInvitadosParaEsteServicio;
                    let cantFinalDisplay;
                    if (esIndivisible) {
                        cantFinalDisplay = cantidadTotalEventoFinal.toFixed(0);
                    } else {
                        cantFinalDisplay = (cantidadTotalEventoFinal % 1 === 0) ? cantidadTotalEventoFinal.toFixed(0) : cantidadTotalEventoFinal.toFixed(1);
                    }
                    if (isNaN(cantidadTotalEventoFinal) || !isFinite(cantidadTotalEventoFinal)) {
                        console.warn("Calculated quantity is NaN or Infinite for option:", opcionOriginal, "Factors:", factorAjusteIntraGrupo, factorAjusteGlobalDeGrupos);
                        cantFinalDisplay = "Error"; 
                    }

                    detalleHtmlComponentes += `<li class="componentes-display-item">${opcionOriginal.nombre_display_cliente} <span class="componente-cantidad-display">(Cant: ${cantFinalDisplay} ${unidadFinal})</span></li>`;
                    componentesSeleccionadosParaItem.push({
                        id_opcion_componente: opcionOriginal.id_opcion_componente,
                        cantidad_opcion_solicitada_cliente: "1", 
                    });
                });
            });

            if (componentesSeleccionadosParaItem.length === 0 && currentConfiguredVariantEstructura.grupos.length > 0) {
                alert("Debes seleccionar al menos una opción de algún grupo para añadir el servicio, si la variante tiene grupos configurados.");
                return;
            }
            
            const precioEstimadoItem = currentConfiguredVariant.precio_base_sugerido || 0.00; 
            const nuevoItemIdx = itemCotizacionIndex;
            
            const itemHtml = `
                <div class="item-cotizacion-card" data-item-idx="${nuevoItemIdx}">
                    <input type="hidden" name="items[${nuevoItemIdx}][id_variante_servicio_config]" value="${currentConfiguredVariant.id_variante_config}">
                    <input type="hidden" name="items[${nuevoItemIdx}][numero_invitados_servicio_item]" value="${numeroInvitadosParaEsteServicio}"> 
                    <div class="item-cotizacion-header">
                        <h5 class="item-nombre-display">
                            <input type="text" name="items[${nuevoItemIdx}][nombre_display_servicio]"
                                   value="${currentConfiguredVariant.nombre_variante}" class="input-inline-editable" required>
                        </h5>
                        <button type="button" class="button button-danger-small remove-item-cotizacion-btn">Eliminar</button>
                    </div>
                    <div class="form-grid-2col">
                        <div class="form-group">
                            <label for="items_${nuevoItemIdx}_cantidad_servicio">Cantidad del Servicio:</label>
                            <input type="number" name="items[${nuevoItemIdx}][cantidad_servicio]" id="items_${nuevoItemIdx}_cantidad_servicio" value="1.0" min="0.1" step="any" class="input-cantidad-servicio-integral">
                        </div>
                        <div class="form-group">
                            <label for="items_${nuevoItemIdx}_precio_total_item_calculado">Precio Total Ítem (Estimado):</label>
                             <input type="number" step="0.01" name="items[${nuevoItemIdx}][precio_total_item_calculado]" id="items_${nuevoItemIdx}_precio_total_item_calculado"
                                   value="${parseFloat(precioEstimadoItem).toFixed(2)}" class="input-precio-item-integral" readonly style="font-weight:bold; background-color:#e9ecef;">
                        </div>
                    </div>
                    <div class="form-group">
                        <small class="text-muted">Este servicio se calculará para <strong>${numeroInvitadosParaEsteServicio}</strong> invitados.</small>
                    </div>
                    <div class="form-group">
                        <label for="items_${nuevoItemIdx}_descripcion_servicio_cotizado">Descripción (para el cliente):</label>
                        <textarea name="items[${nuevoItemIdx}][descripcion_servicio_cotizado]" id="items_${nuevoItemIdx}_descripcion_servicio_cotizado" rows="2" class="input-descripcion-servicio-integral">${currentConfiguredVariant.descripcion_publica || ''}</textarea>
                    </div>
                    <div class="componentes-seleccionados-display-container">
                        <strong class="componentes-display-titulo">Componentes Seleccionados (Estimación para ${numeroInvitadosParaEsteServicio} inv.):</strong>
                        ${detalleHtmlComponentes ? `<ul class="componentes-display-lista">${detalleHtmlComponentes}</ul>` : '<p class="componentes-display-none"><em>Servicio base o sin componentes detallados.</em></p>'}
                        ${componentesSeleccionadosParaItem.map((comp, compIdx) => `
                            <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][id_opcion_componente]" value="${comp.id_opcion_componente}">
                            <input type="hidden" name="items[${nuevoItemIdx}][componentes][${compIdx}][cantidad_opcion_solicitada_cliente]" value="${comp.cantidad_opcion_solicitada_cliente}">
                        `).join('')}
                    </div>
                </div>
            `;
            if (itemsCotizacionContainer) itemsCotizacionContainer.insertAdjacentHTML('beforeend', itemHtml);
            if(noItemsMessage) noItemsMessage.style.display = 'none';
            itemCotizacionIndex++; 

            if(selectTipoServicio) {
                selectTipoServicio.value = '';
                selectTipoServicio.dispatchEvent(new Event('change')); 
            }
            currentConfiguredVariant = null;
            currentConfiguredVariantEstructura = null;
            
            calcularTotalesGeneralesIntegral();
        });
    }
    
    const itemsCotizacionContainerEl = document.getElementById('items-cotizacion-container-integral');
    if (itemsCotizacionContainerEl) {
        itemsCotizacionContainerEl.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-item-cotizacion-btn')) {
                event.target.closest('.item-cotizacion-card').remove();
                let currentIdx = 0;
                itemsCotizacionContainerEl.querySelectorAll('.item-cotizacion-card').forEach(card => {
                    card.dataset.itemIdx = currentIdx;
                    card.querySelectorAll('[name^="items["]').forEach(input => {
                        const oldName = input.name;
                        const newName = oldName.replace(/items\[\d+\]/, `items[${currentIdx}]`);
                        input.name = newName;
                        if(input.id && input.id.match(/items_\d+_/)){
                            const oldId = input.id;
                            const newId = oldId.replace(/items_\d+_/, `items_${currentIdx}_`);
                            input.id = newId;
                            const label = document.querySelector(`label[for="${oldId}"]`);
                            if(label) label.setAttribute('for', newId);
                        }
                    });
                    currentIdx++;
                });
                itemCotizacionIndex = currentIdx; 
                const noItemsMsgEl = document.getElementById('noItemsCotizacionMessage_integral');
                if (itemsCotizacionContainerEl.children.length === 0 && noItemsMsgEl) {
                    noItemsMsgEl.style.display = 'block';
                }
                calcularTotalesGeneralesIntegral();
            }
        });
    }

    const formCotizacionIntegralEl = document.getElementById('formCrearEventoCotizacionIntegral');
    const costoTransporteInputEl = document.getElementById('costo_transporte_cotizacion');
    const costoViaticosInputEl = document.getElementById('costo_viaticos_cotizacion');
    const costoHospedajeInputEl = document.getElementById('costo_hospedaje_cotizacion');
    const montoCostosLogisticosHiddenEl = document.getElementById('monto_costos_logisticos_cotizacion_hidden');
    const displaySubtotalServiciosEl = document.getElementById('displaySubtotalServicios_integral');
    const displayCostosLogisticosEl = document.getElementById('displayCostosLogisticos_integral');
    const displaySubtotalGeneralEl = document.getElementById('displaySubtotalGeneral_integral');
    const displayDescuentoGlobalEl = document.getElementById('displayDescuentoGlobal_integral');
    const displayImpuestosEl = document.getElementById('displayImpuestos_integral');
    const displayTotalCotizadoEl = document.getElementById('displayTotalCotizado_integral');
    const montoDescuentoGlobalInputEl = document.getElementById('monto_descuento_global_cotizacion');
    const montoImpuestosInputEl = document.getElementById('monto_impuestos_cotizacion');


    function calcularYActualizarCostosLogisticos() {
        const transporte = parseFloat(costoTransporteInputEl.value) || 0;
        const viaticos = parseFloat(costoViaticosInputEl.value) || 0;
        const hospedaje = parseFloat(costoHospedajeInputEl.value) || 0;
        const totalLogistico = transporte + viaticos + hospedaje;
        if (montoCostosLogisticosHiddenEl) { 
             montoCostosLogisticosHiddenEl.value = totalLogistico.toFixed(2);
        }
        if(displayCostosLogisticosEl) displayCostosLogisticosEl.textContent = '+$' + totalLogistico.toFixed(2);
        return totalLogistico;
    }

    function calcularTotalesGeneralesIntegral() {
        let subtotalServicios = 0;
        if(formCotizacionIntegralEl){
            formCotizacionIntegralEl.querySelectorAll('.item-cotizacion-card').forEach(card => {
                const cantidadInput = card.querySelector('.input-cantidad-servicio-integral');
                const precioInput = card.querySelector('.input-precio-item-integral');
                const cantidad = parseFloat(cantidadInput.value) || 1.0;
                subtotalServicios += (parseFloat(precioInput.value) || 0) * cantidad;
            });
        }
        if(displaySubtotalServiciosEl) displaySubtotalServiciosEl.textContent = '$' + subtotalServicios.toFixed(2);

        const costosLogisticos = calcularYActualizarCostosLogisticos();
        const subtotalGeneral = subtotalServicios + costosLogisticos;
        if(displaySubtotalGeneralEl) displaySubtotalGeneralEl.textContent = '$' + subtotalGeneral.toFixed(2);

        const descuentoGlobal = parseFloat(montoDescuentoGlobalInputEl.value) || 0;
        if(displayDescuentoGlobalEl) displayDescuentoGlobalEl.textContent = '-$' + descuentoGlobal.toFixed(2);

        const impuestos = parseFloat(montoImpuestosInputEl.value) || 0;
        if(displayImpuestosEl) displayImpuestosEl.textContent = '+$' + impuestos.toFixed(2);

        const totalCotizado = subtotalGeneral - descuentoGlobal + impuestos;
        if(displayTotalCotizadoEl) displayTotalCotizadoEl.textContent = '$' + totalCotizado.toFixed(2);
    }

    if (formCotizacionIntegralEl) {
        formCotizacionIntegralEl.addEventListener('input', function(event) {
            const target = event.target;
            if (target.classList.contains('input-precio-item-integral') ||
                target.classList.contains('input-cantidad-servicio-integral') ||
                target.id === 'costo_transporte_cotizacion' ||
                target.id === 'costo_viaticos_cotizacion' ||
                target.id === 'costo_hospedaje_cotizacion' ||
                target.id === 'monto_descuento_global_cotizacion' ||
                target.id === 'monto_impuestos_cotizacion' ||
                target.id === 'numero_invitados_proyecto' || 
                target.id === 'config_numero_invitados_este_servicio' 
             ) {
                if (target.id === 'numero_invitados_proyecto' && displayInvitadosGeneralesEvento) {
                    const numInvProyectoVal = target.value || '1';
                    displayInvitadosGeneralesEvento.textContent = numInvProyectoVal;
                    if (chkUsarInvitadosGeneralesEvento && chkUsarInvitadosGeneralesEvento.checked && inputNumeroInvitadosEsteServicio) {
                        inputNumeroInvitadosEsteServicio.value = numInvProyectoVal;
                    }
                }
                calcularTotalesGeneralesIntegral();
            }
        });
        // Inicializar cálculos al cargar la página
        if (inputInvitadosProyecto && displayInvitadosGeneralesEvento && chkUsarInvitadosGeneralesEvento && inputNumeroInvitadosEsteServicio) {
            const numInvInicial = inputInvitadosProyecto.value || '1';
            displayInvitadosGeneralesEvento.textContent = numInvInicial;
            inputNumeroInvitadosEsteServicio.value = numInvInicial;
        }
        calcularTotalesGeneralesIntegral(); 
    }
});
</script>
{% endblock %}
